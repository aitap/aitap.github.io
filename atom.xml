<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
	<title>Perhaps I should start a blog</title>
	<link href="https://aitap.github.io/" />
	<id>https://aitap.github.io/atom.xml</id> <!-- it's an IRI all right -->
	<updated>2018-08-21T00:00:00Z</updated>
	<author>
		<name>Ivan Krylov</name>
		<email>krylov.r00t@gmail.com</email>
	</author>
<entry>
			<title>Histogram flattening palette in R</title>
			<link href="https://aitap.github.io/2018/07/21/flathist.html" />
			<id>https://aitap.github.io/2018/07/21/flathist.html</id> <!-- unique enough -->
			<updated>2018-07-21T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p>If you&#39;ve ever done digital photo processing, you&#39;ve probably used the <a href="https://docs.gimp.org/en/gimp-tool-curves.html">Curves</a> tool that provides an intuitive way to enhance contrast in some brightness ranges by scarificing it in other ranges. Basically, the steeper the curve is, the more contrast will increase. But resulting brightness range has to stay the same, so if you increase the slope anywhere, you then have to decrease it somewhere else (or cut off some brightness values, making them insidtinguishable).</p>

<p>Let&#39;s take a look at this nice picture and try applying different sigmoidal transforms to it:</p>

<p><img src="moscow.png" alt="" class="center" /></p>

<p>We can highlight the details of the clouds by blacking out everything else, look at the houses by sacrificing darker and brighter parts of the picture, or just white everything out for no visible profit. The reason for different midpoints of our sigmoidal transformation function highlighting different amounts of details is that some intensities are more present on the image than others:</p>

<p><img src="mow_hist.svg" alt="" class="center" /></p>

<p>Which is why it&#39;s useful to white out everything after the peak corresponding to "white" color if you are working with badly produced scans (or, worse, photos) of paper documents:</p>

<p><img src="paper.png" alt="" class="center" /></p>

<p>Let&#39;s assume that we are working with single-channel/false-color images (so, no <span class="caps">RGB </span>or anything, just a single matrix of intensity values) and want to highlight the variance in brightness ranges which are occupied by most pixels (i.e. where are peaks of the histogram) at the expense of less populated signal levels (i.e. where histogram/density/frequency value is lower)<sup class="footnote"><a href="#fn1">1</a></sup>. The brightness transformation function should have the steepest jumps where there are the steepest jumps on the histogram, i.e. we just need to compute cumulative sum of the histogram to generate our transfromation function.</p>

<p>In fact, there&#39;s a simpler way to express that transformation, and it&#39;s <a href="https://en.wikipedia.org/wiki/ECDF">empirical cumulative distribution function</a>. Like <img src="data:image/gif;base64,R0lGODdhmAAUAPMAAP///9XV1crKyr+/v7W1tampqZKSkm5ubmFhYVRUVEZGRjg4OCgoKAAAAAAAAAAAACwAAAAAmAAUAAAE/xDISau9OOvQcAtaKFrcaGrfqa4hB14uK8dTJ4v0JTQ8T9i8RKLHOwgowWFvOMrBUjeTE2Az7U5TgODQOEp2CMpiQRkgEN7JeDIQjrqia/SdBnAQvdAOaq1ODmgWfjwVAggHFYRscBt8GVlzFTkcdRl7lU2OAw0DF4N+EpudNVUdcpagGYyRGKdUmBaXUasACAlvqQAJYTVkEkCFq7QcBz88L643PJvHv3WcjbSPDcU9yJ+4noMMPbzBeDUUHAVDR6egROl5wQbQm78VBHjrSAVSDeRw50i5grmKv3xR8VdpEAhogiI1kIcI3kAKgEY9kebpoEQkFGxl88cvXKKLDujFOfKoUCKwCTtgBaNIYmRIAKI8dawwQIE3Kv1+gXwo8kUiVjTkDFKpgwdROy55SgBUyRXAL2ee5YRJT2mNIyVI/lKX7sImL4wGsdjjUxBWsRS2rNpRdg2bqBXcPsEUVsCOW2xRTjURkerVGjtHJOtyVwufZF/S+UySzgg/IU//xrLBYSEXRyxV7ChgTS+po1h8XC6bmdUbDJAkJVWRtaVPWaZRr44dAqHZOHsF55S2h/Zk3yyMPinrOtLmacQ5a+Oae0Jq4BrIFh/OqsE85Ftnz3kOPYTylh6Id3fevLr48SKaoV/PHkAEADsAAAAAAAAAAAA=" />, its <a href="https://en.wikipedia.org/wiki/Cumulative_distribution_function">probability-theoretical counterpart</a>, eCDF calculates the fraction of points in the dataset that are less than given value:</p>

<p class="center"><img src="data:image/gif;base64,R0lGODdhGAE/APMAAP///9XV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRjg4OCgoKBgYGAAAAAAAAAAAACwAAAAAGAE/AAAE/xDISau9OOvNu/9gKG5B0wiAYDbB6L5wLM90bd9WMwwHcgKDBm5ILBqPyKRECEAgUEuldEqtWmvC4GCiunq/4HDVYKD8xOi0ev1RbSUltnxOR5daki6zzu/7cV0TOkF/hYaHIGdLBYqIjo9UhDB7cCaQl5hFKwkImZ6ffAqUFw0+pSuoqaompiYHUKCxshWWG6INCiM8uAwNDAezwbO1Gge9Cm+6Bwq9ws6fxBkCCAwMTzADCAnJz90YcR0sU9HS1NawIwIHZd4cKqhQgYd3HvRK5BkDor8xKujtFQQYUPSOgBMzrFqhMvBPUMJVPmj4AzExCb4MxnBxGwHuwi5n6v9eWVCxYJQEBbkqDBjYkAJKC9k6zSAjgqZFk+WqXcNRokFJYSFbnsR5MUWpDBe1yFB6QZ5KHTdB6PMFDMcPUcIObCsmkxZOQRsdYrAJowfGrhYQVD1SFOOxsFi+YhqQYC0GSV41kM3rUe4HtUjlmkXykqK5nVb9QtIKlxYpv0z5CpqMDSqGwn0bz1jhpG3Tw0JjeK7T0wQesS5GA85BCa+MwV4TLEiw4sJqOVP5Jb7iNIcGNxKCoButYfRFXBNixs2AGcPxVdAVx8iIbDeVd6dJSVtH4TYA4oE3HC+54ieNtsalj4gOngvoG+0lmghN+cKyClhRr1d8PCWQg+fJlR7/H7nZtZl6M7xDnxlIkccZJfGxJh5RrX3FHiqSqVTXhH1Qp9l+GvQkwDsRGtWIcw8R5R8GjHFAoQZ0GbjEKAiG81WLxdUIgogmiiPCNAyYF2AGJQiw0hk1KhiCX6PF6OJjeokkIRFFEVeiB4P08INrUnGy4JICogDckgcUsF4xW6H5YW8z5mPZlB+UJqYJDGWIUCUoPnYhhr41gZiOFEQ2pHN5AJoHSyGwSYE67OC56AFSWmCPnclxl2ecW2qJwoYUwMbXiRN4hwUQbyrqjqU2WPmlNPN9AGpAlqmQXR6QNjQpfisGN1Cdl+UqHiwatRnom50mQOpdxN6w16sbBIVD/3MX3Eooq8w6xkFpPo6EKBfZOlSKQisY0BhnrYSTHKcZiHqoaSyidcOYAHTURq2ppvjVpIZyW20U8eY7kiqzioHjWS6oW8OkeoBgQKRWnGFqG61Ou68sxAnqgcU2ODVIkhMP8YMK4hoVcDpVHgvQdxCO1egHe1k1HCOr9jsyEnKSODN87IJESX5GYVCRBz97XEFP9XQ7R84nbyaTCgkYKzKRRkN9cxhBuyAvIA0wkrREA813JNLfIBh1GozKUDV8Rvq79dqnMpwOgGzFzPbcHiws910ILCAj1iheSPff3N4N0zIMVMfWAA8DrrjPWbuwCzO1IZF1x4tXPs0Ct+ypCnjkK+h2BNGVh14cuJqz57boqKeu+uqusu7667DHjpvasteuiQmc2K77Gjzv7vsXV/4ee09TvxC88K9vrOee4SHvvGOJG0/786gLQbkIx1O/+tgyZK896tFL/z31P0wP5fjOC8Fm6QKajz7gkxc/ArTv6w529ylmEgEAOwAAAAAAAAAAAA==" /></p>

<p><img src="inthist.svg" alt="" class="center" /></p>

<p>It can also be shown that the result of taking cumulative distribution function of a variate is uniformly distributed, i.e. has flat histogram, which is <a href="https://en.wikipedia.org/wiki/Histogram_equalization">how this technique is remembered everywhere</a>. So, just by plotting <img src="data:image/gif;base64,R0lGODdhUAATAPMAAP///9XV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRjg4OCgoKAAAAAAAAAAAAAAAACwAAAAAUAATAAAE/xDISau9OGscGGbBJo5kKXXhhZoC47qEB7gI8rqGMNH2a5erTHAjMDB0ktaBolBQBocDUtKcDGqlo6g1MkgtMomrIjgYKGOrVjQUgjYDxuASntUl8bk47OFu7xlrJy8pBwgjaRUIS2JOYo8iggAdBjEuKX6TWnF7iIB2OwsvjCR1HQU2Opl8BTudkZ+JDI4zJnVvcnQTBzcyhp50fHy2Fm2ukBV5ujuAAwmkiSa1FcbIkhNeU0m3d2Vfr4EMvLJ0Oh1oEx2qYUWCLSlUtABQ3/EaXDJ8SEcth+8TmTRdItMLHo9eOZjViIYmBCA/HRgQMPJmhzZpGIlRq6ihWsaPGiViXbwQEKTJCvwYIChwx2M6jidjDpJoBN5LmxRcytzJ4dMMnBEAADsAAAAAAAAAAAA=" /> instead of <img src="data:image/gif;base64,R0lGODdhEAAIAPMAAP///9XV1crKyr+/v7W1tampqW5ublRUVAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAEAAIAAAEJxBIGZAhKIfJazmIAAgINyEbMpgshbZstcFmCFRtSB7jG2cEg8YUAQA7AAAAAAAAAAAA" />, you already highlight the differences in mostly populated intensity ranges and enhance the contrast. If you do that to a photograph, the result would probably look weird (because you&#39;re now plotting quantiles instead of intensity values as perceived by the camera), but most scientific pictures already look weird even before you apply false colors, so that should not be an issue.</p>

<p><img src="mow_flat.png" alt="" class="center" /></p>

<p>But what if you had an R palette and wanted to feed your original data to a plotting function in R and make the histogram-flattening transform by applying a special kind of palette produced from the original you had?</p>

<p>R palettes are just vectors of colours (strings of hex codes, like <code>&quot;#00FF00&quot;</code> or <code>&quot;#FF4900FF&quot;</code> or colour names, like <code>&quot;palevioletred3&quot;</code> or <code>&quot;lightgoldenrodyellow&quot;</code>). If you plot a continuous numeric variable, R assumes that the palette uniformly covers the entire range of the colour-described variable<sup class="footnote"><a href="#fn2">2</a></sup> and assigns the colour that would be the closest on that grid. There are built-in functions that generate nice-looking continuous palettes of specified sizes: <code>heat.colors</code>, <code>topo.colors</code>, <code>terrain.colors</code>, <code>rainbow</code>, <code>grey.colors</code>, <code>cm.colors</code>. Some packages also follow this pattern, like <code>cubeHelix</code> from <a href="https://cran.r-project.org/web/packages/rje/index.html">rje</a> package:</p>

<p><img src="palettes.svg" alt="" class="center" /></p>

<p>If you have a set of colors and want to have a continuous palette produced from them for you automatically, there is <code>colorRampPalette</code> function that takes a vector of colors and returns a palette-function (like ones described above):</p>

<p><img src="color_ramp_palette.svg" alt="" class="center" /></p>

<p>We will also follow the palette-function pattern, which means that the function we are going to write will both accept and return a function. Functional programming <span class="caps">FTW</span>!</p>

<p>The problem with <span class="caps">CDF </span>is that it&#39;s right-continious and constant between discontiniuities. So, unlike <img src="data:image/gif;base64,R0lGODdhWAAWAPMAAP///9XV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRjg4OCgoKAAAAAAAAAAAAAAAACwAAAAAWAAWAAAE/xDISau9OGsb2M5M8I1kmXWiOaGjwLwv4QEvgsCvIUz1Dd8klooixAgMjJ3EdaAoFJTB4aCUPCcDGyk5tLg0BqplJnlVBAcDxYzlbopdCTzKGFzINLxkUOeRPV8bgXFrOx0vKQcII2wVCE1lUGWTAB0GMohlVUQMlzApGS4dO3xlehiNa38LMJByDAU3O4GnlbCyAIMgsDymjLWNDJI0ayJ9FcDGdiUMBzgzir93f38cIWMn18y1fMvIqhYDCa6p1qC9GHNrY24VYZu5eOVoYr4aXB3oqIa1ZyFcg460E+VkGAAp9awY5CHAxSKCmpA1ZPBQm4YvhywueQaqxzMdfkpslDtEAIlGXbYYlMz0oR2hlx/UDZEJs6ZEE4fOobTJk9O5DSplrNDYs+irnyBoKKFplGc+EqXKIG1KdYu3qliHwOqXtWu6chIiAAA7AAAAAAAAAAAA" />, which is always different for different <img src="data:image/gif;base64,R0lGODdhEAAQAPMAAP///9XV1crKyr+/v7W1tampqW5ublRUVAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAEAAQAAAEPRCAgAxBOMgtaTmIAAgItyEaMphsh7YspcHlKVJtSB7jG2MEQwZGLBIpviKCcDECSiEnYFBzqqTPQrWIjAAAOwAAAAAAAAAAAA==" /> taken from original dataset, we probably will get non-unique values if we evaluate eCDF on a uniform grid:</p>

<p><img src="ecdf_uniform.svg" alt="" class="center" /></p>

<p>Same colours in a continuous palette (or, actually, any kind of palette) are a bad thing: they make different values non-distinguishable even if they got assigned to different colours in the palette. (In the end, we are still going to get non-distinguishable colors in value ranges far from histogram peaks - because we&#39;re interested in distinguishing densely-populated ranges - but we have to try, at least.) Moreover, the more points we request on that linear grid, the more repeats we&#39;ll get; and we are <strong>bound</strong> to get some non-uniques if the number of points in the grid exceeds the number of points in the dataset.</p>

<p>What to do? eCDF is just an estimate of the original <span class="caps">CDF </span>of the distrubition your points were sampled from. And your original distribution is hopefully continuous. So let&#39;s replace some of the repeats with interpolated values, so that all values are unique again:</p>

<p><img src="ecdf_uniform2.svg" alt="" class="center" /></p>

<p>We could probably try to get a smooth curve instead of linear interpolation, but splines are not guaranteed to be non-decreasing, so let&#39;s keep it simple. Now that we have a number of unique points in <img src="data:image/gif;base64,R0lGODdhIAATAPIAAP///9XV1crKyr+/v2FhYVRUVAAAAAAAACwAAAAAIAATAAADZQhqbPowwuZilTiD+3hoQTZwm3R9AiAYoWUQltmlypqRZLnEGC7vkwXHx9N1hMGkkvg7FplF4DKqlDo3NFXOaryitC1GtWv9MFoAQkFIEHPJmJEGvm327BmbJlefoO8ubnMmDQ8JADsAAAAAAAAAAAA=" /> range, let&#39;s call the original palette function and take colours at corresponding indices.</p>

<p>But how many colours should we request from the original palette function? If we don&#39;t request enough, our calculated indices will be repeated and our new palette will produce same colours for different values. In a perfect world consisting of purely Platonic ideas of <img src="data:image/gif;base64,R0lGODdhEAAMAPIAAP///93d3dXV1crKyr+/v2FhYQAAAAAAACwAAAAAEAAMAAADMwhqVsxCSWlAVcPEuezMXHdh41SN2cZVTqOF4kLAYmQMtGcEgPDCpw0IaMEtjCvGxDdJAAA7AAAAAAAAAAAA" />eal numbers, there&#39;s one trick that would give us the exact number of colors we should request so that all indices recomputed from <img src="data:image/gif;base64,R0lGODdhcAATAPMAAP///93d3dXV1crKyr+/v7W1tampqW5ubmFhYVRUVAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAcAATAAAE/xDISau9OOvNqfpKV4GhaJ5oOqorK34IKbh0KQngfBG21NOZkG2g0Hl+QIsNNwAQjRNYi4YjrXpEJRJVBU0VTUn28tuemEEA9jdAIMIqNMZWnk8tuEMhV8FBlWoTTyMEPBd5ex9/fhp0LR8edxQ4BglgTmVwdjEKMX9jl5MKlZdjUZpkUY89dWQzCgRpG0I+sSNhpj6vtqmzqpG9vxiMGJwkdUVqqLmhon8UxlbAgdOSZjfJdr4KAQDEPpq52M/CstTl1edzTThKqIDZpuLK7t5Izdr0Ymatt0QJmJ59S9UsFL594P4FxJMtH5pBalhJwqagwAFFww4e6dFOHbAqFjUxHtJYrosRBAAjckIX51gSF10gpdtxzePLmzhZBtuZs+fLmgjN+Rxag0NDnkSTnpC21MuECAA7AAAAAAAAAAAA" /> to <img src="data:image/gif;base64,R0lGODdhcAATAPMAAP///93d3dXV1crKyr+/v6mpqZ6enmFhYVRUVEZGRjg4OCgoKBgYGAAAAAAAAAAAACwAAAAAcAATAAAE/xDISau9OOtdm29ceH1gJ54oUKJr6rbu1Axj/FoEbHmIR3kH389WCQp2Ox1RAgNyCgmGgkApKJUXAalp0HmxGi3JhNw0CojF4Ucrb7TtWoM6pAwOh3gInrm+QQQKUxJaR24ehhSFGiBGdTIEOUmJE4t9NTIwiwdqhA2UMhIDZ156claJLaNMeqNWO6ZujyowqwCBg7ZlM5JkjCoAli0zosMDvbMYfoxxnGvEmKwWQVtNKgHBn8DFbB2x1Fu+yRWWt4IqsUwTuuNIDdgAqyvQ3OvLv7IW5QCcCwiXTAiwQ2dGRaou9boFHEhPWbQLAwMxWOOQiRVT+9zF0UKxYUJSGFC1ARQn5NaZaQnoRBOTxeOPkvWwrGCpz2Wol9QkHPhHK6cdMNs4iPmwJMZQmEEzICMCtKjTE03VFY36tOrIDANjULXKtV0HUFq7ig0xZuyYCAA7AAAAAAAAAAAA" /> would be different: <img src="data:image/gif;base64,R0lGODdhcAAnAPMAAP///93d3dXV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRgAAAAAAAAAAAAAAAAAAACwAAAAAcAAnAAAE/xDISau9OGeytP9gKI4ksCxIqa5s63VuLM8fTN+4bOd8L+6+1WkY/BV/QxjwWGOSlE5jNASdNq3XJXZyQpy2mSp4/JRoyWiMmJtsu9/wuHxOr8st67T+kt/7zYBCZxSDf4R4gSpfL4ZXhyZFhY2QFX04ko1LljeYhpqJXAcFQwMDQwJsXF4nqKBdRC2vizGflBUJCwMABAe5uzvAEhxcE6aUnRnGmyW1WgsEXNCujwILrTbWtmp3ZqjIUo/Oj9PEAAELAaDq5WV8Qohh49rBANXX8DPfGMPsVNIm/55FG2hKmpJSCxIY0IcHocJOmlDIq+HFTEUTF1EoyVil2oICvVlarfAIMpujShOnYLI3gyU+lP3yUamxMF/Nl/IYcvpgSpeMnmxOKEiScwzEf7SQxuyn00qCFDOeupuawyWNWbTEVdLY9MXNSRq6sgAK1pPSsmmkovWDdS2NCAA7AAAAAAAAAAAA" />. Except when <img src="data:image/gif;base64,R0lGODdhaAAbAPMAAP///9XV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRgAAAAAAAAAAAAAAAAAAAAAAACwAAAAAaAAbAAAE/xDISau9UuHNu/+bBipiV4Joql6n2WLvKs8hXdt4nulVzP8en00ILFpIBgJJIRAsAxNSNPmMUgIKKglqw2oV3J8GwQQMDOXB6UQWmEslbKENcHYV87IdqFEMon87VoCDAHBQfjxghoFGho+FkIKTki1YYRxLmksVl447axShkXCdizArnqhDkq2jlKU9bliKs0Qfaj2MhBmNib28IkxOCHWnM8MKxU6YmSwKBz3QwgfU1hnV2MISWAoEaMcz3d9bKEIttzLpn0E3kSYjIN3Nd+HvorpF64YESmL9Mc7l4xOvjCJDbgxpSrAJn0OCIHIBkXjEHSV2IRop0viwoop5Rivw7BtRIKDFEQCNdAOy0qO0aiMfGcRIMyYumzRzjuCos+eQkj6D1hNKtEIEADsAAAAAAAAAAAA=" /> is so small that requested amount of colors would start having troubles fitting into computer <span class="caps">RAM, </span>the difference would be impossible to perceive with human eye and impossible to express in 24-bit <span class="caps">RGB </span>in the first place. But even if we limit ourselveswith <img src="data:image/gif;base64,R0lGODdhqAAXAPMAAP///9XV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRjg4OCgoKBgYGAAAAAAAAAAAACwAAAAAqAAXAAAE/xDISau9OOtdQ/tNwI1kaZ5oqqLNIA3NKs90bVseKGLx1N/AoHDYev00guNwyWx6NsdeCAMTNK9YoGeXKQJgkq3lc8hKvGPXBb38ID4UMlwmnuSmEsGh8ebWKw1WMmAUd1x7IHMAiIkTjCB2OhSEkR9cFAUJDApqEgVKKoEUSS5VLwkKCAQVSRetK2SFoq+vnj21AJ95R7oApF+iALGRVrg+BQgLZT6CdHgSBwgTBgYSBgcDSZd1P8YpP38+fnjP3OM70dPVPpGXODEDCpxhzyvGisJnaveCRdo0P9hcCNdu4DN8UXx0wiDmgDJ67r41u5AuH7tRPQzVCPjJ0pqJce5AMstQ8cwxSRZexZvn7Uyil/gsZkCwzAuli1BgvlzjaFY9AAQhGow4gWacnsV+CmvmsEywGaAwCrqjNOpGhROMtfRldSvXiQE7GfuzculVhkq7tMFpMiQPkWfgAv0ZEFCHeg4XSDv7jqhaIiPZyhzzty/huEcxVojHYNkanY0S391h9XBOyDHbcs2qpLLnoZpl1sIFo4CFAwkWyni6y3ToDF6hxnHxT7Ll263ZRqF9sAEiVpVR3HsUPDAQORlR2rbLYwxxl7/nejQjy2+JoNSzayfBOkXs7eDDC1WBXbz58OU3pD/PPvsTFtbbh48AADsAAAAAAAAAAAA=" />, which is the total number of colours you can express in R using <code>#RRGGBB</code> notation (not counting transparency channel which is not used and would take 256 times more) it&#39;s still too much because none of the continuous palette functions manage to fit the entire (three-dimensional) <span class="caps">RGB </span>space into one linear range of values. In fact, palette functions stop producing unique colours after a few thousands, and most don&#39;t even reach that much:</p>



<pre>
<span style="color:#000000">&gt;</span> <span style="color:#000000; font-weight:bold">for</span><span style="color:#000000">(</span>i <span style="color:#000000; font-weight:bold">in</span> <span style="color:#000000">(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">1</span><span style="color:#000000">):(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">3</span><span style="color:#000000">))</span> <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span><span style="color:#010181">length</span><span style="color:#000000">(</span><span style="color:#010181">unique</span><span style="color:#000000">(</span><span style="color:#010181">rainbow</span><span style="color:#000000">(</span>i<span style="color:#000000">))) !=</span> i<span style="color:#000000">) {</span><span style="color:#010181">print</span><span style="color:#000000">(</span>i<span style="color:#000000">);</span> <span style="color:#000000; font-weight:bold">break</span><span style="color:#000000">}</span>
<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span> <span style="color:#b07e00">1531</span>
<span style="color:#000000">&gt;</span> <span style="color:#000000; font-weight:bold">for</span><span style="color:#000000">(</span>i <span style="color:#000000; font-weight:bold">in</span> <span style="color:#000000">(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">1</span><span style="color:#000000">):(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">3</span><span style="color:#000000">))</span> <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span><span style="color:#010181">length</span><span style="color:#000000">(</span><span style="color:#010181">unique</span><span style="color:#000000">(</span>topo<span style="color:#000000">.</span><span style="color:#010181">colors</span><span style="color:#000000">(</span>i<span style="color:#000000">))) !=</span> i<span style="color:#000000">) {</span><span style="color:#010181">print</span><span style="color:#000000">(</span>i<span style="color:#000000">);</span> <span style="color:#000000; font-weight:bold">break</span><span style="color:#000000">}</span>
<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span> <span style="color:#b07e00">543</span>
<span style="color:#000000">&gt;</span> <span style="color:#000000; font-weight:bold">for</span><span style="color:#000000">(</span>i <span style="color:#000000; font-weight:bold">in</span> <span style="color:#000000">(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">1</span><span style="color:#000000">):(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">3</span><span style="color:#000000">))</span> <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span><span style="color:#010181">length</span><span style="color:#000000">(</span><span style="color:#010181">unique</span><span style="color:#000000">(</span><span style="color:#010181">cubeHelix</span><span style="color:#000000">(</span>i<span style="color:#000000">))) !=</span> i<span style="color:#000000">) {</span><span style="color:#010181">print</span><span style="color:#000000">(</span>i<span style="color:#000000">);</span> <span style="color:#000000; font-weight:bold">break</span><span style="color:#000000">}</span>
<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span> <span style="color:#b07e00">356</span>
<span style="color:#000000">&gt;</span> f <span style="color:#000000">&lt;-</span> <span style="color:#010181">colorRampPalette</span><span style="color:#000000">(</span><span style="color:#010181">palette</span><span style="color:#000000">())</span>
<span style="color:#000000">&gt;</span> <span style="color:#000000; font-weight:bold">for</span><span style="color:#000000">(</span>i <span style="color:#000000; font-weight:bold">in</span> <span style="color:#000000">(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">1</span><span style="color:#000000">):(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">3</span><span style="color:#000000">))</span> <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span><span style="color:#010181">length</span><span style="color:#000000">(</span><span style="color:#010181">unique</span><span style="color:#000000">(</span><span style="color:#010181">f</span><span style="color:#000000">(</span>i<span style="color:#000000">))) !=</span> i<span style="color:#000000">) {</span><span style="color:#010181">print</span><span style="color:#000000">(</span>i<span style="color:#000000">);</span> <span style="color:#000000; font-weight:bold">break</span><span style="color:#000000">}</span>
<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span> <span style="color:#b07e00">621</span>
</pre>



<p>So let&#39;s limit our number of colours to a nice and modest value of 2048 but leave that as a parameter. Now that we know our N, calculating the indices is fairly simple: <img src="data:image/gif;base64,R0lGODdhqAATAPMAAP///93d3dXV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRjg4OCgoKBgYGAAAAAAAACwAAAAAqAATAAAE/xDISau9OOvNheNg6IXk5QjSqX1l63IOO3no69J2ieN572MyAE9CCP4oQ0AsEaPEEM1QcaZKHq+voGPgdCA2RtLWYlA0FgSKIbzyUgYsOHaepdac4JdVaUgwvhNjLUE7KnSHIDJyFmx4LotIHwQLaBJ7MBWCgimGOQ4HBZ9cljGdUUoyn6Exd0Kla4GjmXkYHqClNZt2AAh/pK0hRouQcLCZpcjIFkwFByweXHB3m0FMXFOk0W4pQLQWHn1ji2yLk5WQJWGpsdg9DmlOsotDWvBKsY73Jt6ZKO+MJmT1+qJLDEBu8X6omwUggIMAgfLpm4iQokRUyBQkq7AnzBBzSsFkcUpW6uLEIOg8HYzY8CHLiicZWnzZLUPHb514MWCQwMZCmO9SkiS5Ep+EeaYkphK5bt8KMFxGwDxqZFIDQC5+UnSwRmQdjuJMpYGTwN6/FPCgASALr+DUorHIrjUlsogBCwgU2BtUYRihUz6hGPHAKlKMZiy8JIZC5bAzqscEZ2BDGHFOSE8Az82ieGkKr4hC28wZTA9p0b9cAUPNOiHfLKBR+21NG+fq0JcQFbpdm3XuQ7+x7O5NnEpvqagNkY4AADsAAAAAAAAAAAA=" />, and there we have our histogram-flattening palette transformation function:</p>



<pre>
histeq<span style="color:#000000">.</span>palette <span style="color:#000000">&lt;-</span> <span style="color:#000000; font-weight:bold">function</span><span style="color:#000000">(</span>x<span style="color:#000000">,</span> pal<span style="color:#000000">,</span> max<span style="color:#000000">.</span>col<span style="color:#000000">=</span><span style="color:#b07e00">2048</span><span style="color:#000000">, ...) {</span>
	<span style="color:#000000; font-weight:bold">function</span><span style="color:#000000">(</span>n<span style="color:#000000">) {</span>
		<span style="color:#838183; font-style:italic"># palette is assumed to be linear; we're transforming its scale from linear to CDF-shaped</span>
		grid <span style="color:#000000">&lt;-</span> <span style="color:#010181">seq</span><span style="color:#000000">(</span>from<span style="color:#000000">=</span><span style="color:#010181">min</span><span style="color:#000000">(</span>x<span style="color:#000000">),</span> to<span style="color:#000000">=</span><span style="color:#010181">max</span><span style="color:#000000">(</span>x<span style="color:#000000">),</span> length<span style="color:#000000">.</span>out<span style="color:#000000">=</span>n<span style="color:#000000">)</span>
		coords <span style="color:#000000">&lt;-</span> <span style="color:#010181">ecdf</span><span style="color:#000000">(</span>x<span style="color:#000000">)(</span>grid<span style="color:#000000">)</span>

		<span style="color:#838183; font-style:italic"># so, coords[zeroes+1] - coords[zeroes] == 0</span>
		zeroes <span style="color:#000000">&lt;-</span> <span style="color:#010181">which</span><span style="color:#000000">(</span><span style="color:#010181">diff</span><span style="color:#000000">(</span>coords<span style="color:#000000">) ==</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span>
		<span style="color:#838183; font-style:italic"># ECDF is right-continuous, so the last point is always bigger than second-to-last</span>
		<span style="color:#838183; font-style:italic"># but we can still have problems at the first point, which we shouldn't try to extrapolate</span>
		zeroes<span style="color:#000000">[</span>zeroes<span style="color:#000000">==</span><span style="color:#b07e00">1</span><span style="color:#000000">] &lt;-</span> <span style="color:#b07e00">2</span> <span style="color:#838183; font-style:italic"># if coords[2] == coords[1], interpolate second, not first</span>
		<span style="color:#838183; font-style:italic"># replace points where diff=0 with linear interpolation</span>
		coords<span style="color:#000000">[</span>zeroes<span style="color:#000000">] &lt;-</span> <span style="color:#010181">approx</span><span style="color:#000000">(</span>grid<span style="color:#000000">[-</span>zeroes<span style="color:#000000">],</span> coords<span style="color:#000000">[-</span>zeroes<span style="color:#000000">],</span> grid<span style="color:#000000">[</span>zeroes<span style="color:#000000">])</span>$y

		<span style="color:#838183; font-style:italic"># now that every coordinate is different, we know how many colors to request</span>
		<span style="color:#838183; font-style:italic"># so that every index would be different, too</span>
		<span style="color:#838183; font-style:italic"># but don't request too many colours because they won't be unique anyway</span>
		n<span style="color:#000000">.</span>pal <span style="color:#000000">&lt;-</span> <span style="color:#010181">ceiling</span><span style="color:#000000">(</span><span style="color:#010181">min</span><span style="color:#000000">(</span>max<span style="color:#000000">.</span>col<span style="color:#000000">,</span> <span style="color:#b07e00">1</span><span style="color:#000000">/</span><span style="color:#010181">min</span><span style="color:#000000">(</span><span style="color:#010181">diff</span><span style="color:#000000">(</span>coords<span style="color:#000000">))))</span>
		<span style="color:#010181">pal</span><span style="color:#000000">(</span>n<span style="color:#000000">.</span>pal<span style="color:#000000">, ...)[</span><span style="color:#010181">round</span><span style="color:#000000">(</span><span style="color:#b07e00">1</span><span style="color:#000000">+</span>coords<span style="color:#000000">*(</span>n<span style="color:#000000">.</span>pal<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">))]</span>
	<span style="color:#000000">}</span>
<span style="color:#000000">}</span>
</pre>



<p>Let&#39;s feed a scientific image and a false-color palette to this palette-transforming function:</p>



<pre>
<span style="color:#010181">require</span><span style="color:#000000">(</span>fields<span style="color:#000000">)</span> <span style="color:#838183; font-style:italic"># image.plot produces a colour bar with the plot</span>
image<span style="color:#000000">.</span><span style="color:#010181">plot</span><span style="color:#000000">(</span>spectrum<span style="color:#000000">,</span> col<span style="color:#000000">=</span>topo<span style="color:#000000">.</span><span style="color:#010181">colors</span><span style="color:#000000">(</span><span style="color:#b07e00">512</span><span style="color:#000000">))</span>
image<span style="color:#000000">.</span><span style="color:#010181">plot</span><span style="color:#000000">(</span>spectrum<span style="color:#000000">,</span> col<span style="color:#000000">=</span>histeq<span style="color:#000000">.</span><span style="color:#010181">palette</span><span style="color:#000000">(</span>spectrum<span style="color:#000000">,</span> topo<span style="color:#000000">.</span>colors<span style="color:#000000">)(</span><span style="color:#b07e00">512</span><span style="color:#000000">))</span>
</pre>



<p><img src="wavy_spectrum.png" alt="" class="center" /></p>

<p>Most of the image was background, so our signal is whitened out. Instead, we see that some kind of wavy pattern covers all the image, invisible unless you highlight just the right part of the dynamic range. This is actually bad because it could interfere with shape of weak signals, but at least now we know that. (It&#39;s definitely impossible to see just from looking at original 16-bit image.)</p>

<p>Try histogram flattening on your own data to see if there&#39;s any patterns lurking in the middle of the bell curve!</p>

<p class="footnote" id="fn1"><sup>1</sup> This is the opposite of what you usually see on false-color images: the most different values are ones at the far end of the bell curve of the distribution.</p>

<p class="footnote" id="fn2"><sup>2</sup> But see <code>zlim=c(min,max)</code> argument of <code>image(...)</code> function.</p>
				</div>
			</content>
		</entry>
<entry>
			<title>Installing Skype 8 for Linux on 32-bit Debian 9 &quot;Stretch&quot;</title>
			<link href="https://aitap.github.io/2018/07/31/skype.html" />
			<id>https://aitap.github.io/2018/07/31/skype.html</id> <!-- unique enough -->
			<updated>2018-07-31T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p>First things first, there are no miracles: you still need a 64-bit processor to run <code>skypeforlinux64.deb</code>. In fact, quite a lot of code we&#39;re going to install is going to be 64-bit, so let&#39;s get started:</p>



<pre>
<span style="color:#838183; font-style:italic"># Enable multiarch to allow installing non-i386 packages</span>
dpkg <span style="color:#000000">--</span>add-architecture amd64
apt update
<span style="color:#838183; font-style:italic"># Install the 64-bit kernel to run both 32-bit and 64-bit binaries</span>
apt <span style="color:#000000; font-weight:bold">install</span> linux-image-amd64
</pre>



<p>Now reboot into the new kernel (make sure of that in the bootloader menu). Make sure that everything works because we&#39;re going to use only <code>amd64</code> kernel from now on.</p>



<pre>
<span style="color:#838183; font-style:italic"># This part is optional, but doing this ensures that amd64 kernel is going to be default in GRUB menu</span>
apt purge linux-<span style="color:#000000">{</span>image<span style="color:#000000">,</span>headers<span style="color:#000000">}*</span><span style="color:#b07e00">686</span><span style="color:#000000">-</span>pae
apt <span style="color:#000000">--</span>purge autoremove
</pre>



<p>Now we can just install the 64-bit package, right?</p>



<pre>
<span style="color:#838183; font-style:italic"># Commented-out code may break your system</span>
<span style="color:#838183; font-style:italic"># dpkg -i .../path/to/skypeforlinux64.deb</span>
<span style="color:#838183; font-style:italic"># apt-get install -f</span>
</pre>



<p>If you run the above commands, you&#39;ll find out that <code>apt</code> suggests you to wipe half of the package management system (but has enough courtesy to warn you that it may not be the right thing to do, so can you please type that you know what you are doing first?)</p>

<p>What the hell?</p>

<ol>
<li><code>skypeforlinux</code> depends on <code>apt-transport-https</code>.</li>
<li><code>apt-transport-https</code> does <strong>not</strong> have <code>Multi-Arch</code> field in its description. Therefore, it gets pre-multiarch behaviour,</li>
</ol>

<blockquote><p>The package is not co-installable and it must not be used to satisfy the dependency of any package of another architecture than its own.</p></blockquote>

<ol start="3">

<li><code>skypeforlinux:amd64</code> tries to pull <code>apt-transport-https:amd64</code>, which conflicts with <code>apt-transport-https:i386</code> and the rest of <span class="caps">APT.</span></li>
<li>Hillarity ensures.</li>

</ol>

<p>But that&#39;s nonsense, you&#39;d say. (At least, I would.) <code>apt-trasport-https</code> provides, basically, a single executable, <code>/usr/lib/apt/methods/https</code>, which can be called by 32-bit <span class="caps">APT </span>to download whatever <span class="caps">APT </span>wants to download via <span class="caps">HTTPS.</span> There is no reason for it to be a 64-bit executable on a (mostly) 32-bit system. Can we ask <span class="caps">APT </span>to keep the 32-bit version?</p>

<p>Almost.</p>

<p>The <a href="https://wiki.ubuntu.com/MultiarchSpec">Multiarch specification</a> says:</p>

<blockquote><p>If a package is declared <code>Multi-Arch: foreign</code>, preference should be given to a package for the native architecture if available; if it is not available, the package manager may automatically install any available package, regardless of architecture, or it may choose to make this an option controlled by user configuration. <br /><br />
The package is not co-installable and <em>should be allowed to satisfy the dependencies of a package of another architecture than its own</em>.</p></blockquote>

<p>If you feel your tinker-fu high today, you can try to:</p>

<ol>
<li>Take the original <code>apt-transport-https_VERSION_i386.deb</code></li>
<li>Use <code>ar</code> to extract <code>control.tar.gz</code></li>
<li>Extract <code>./control</code> from <code>control.tar.gz</code></li>
<li>Patch in the missing line and increment the version while you&#39;re at it</li>
<li>Try to fit the guts back before abyone notices</li>
<li>Install the resulting package</li>
</ol>

<p>Perhaps it even could work. But we&#39;re building our own version of <code>apt-transport-https</code> from source, just for the sake of one line in the package description. Silly, I know.</p>



<pre>
<span style="color:#838183; font-style:italic"># Install the packages required to build APT and then some</span>
apt-get build-dep apt devscripts
<span style="color:#838183; font-style:italic"># Create an empty directory to work in</span>
<span style="color:#0057ae">cd</span> $<span style="color:#000000">(</span>mktemp <span style="color:#000000">-</span>d .<span style="color:#000000">/</span>apt-XXX<span style="color:#000000">)</span>
<span style="color:#838183; font-style:italic"># Download the apt source code</span>
apt-get <span style="color:#0057ae">source</span> apt <span style="color:#838183; font-style:italic"># I wanted to sneak a GEB reference here, but, well, here it is</span>
<span style="color:#838183; font-style:italic"># Change directory to the source code itself</span>
<span style="color:#0057ae">cd</span> apt-<span style="color:#000000">*</span>
<span style="color:#838183; font-style:italic"># Insert the missing line in the description of apt-transport-https</span>
<span style="color:#000000; font-weight:bold">sed</span> <span style="color:#000000">-</span>i <span style="color:#bf0303">'/^Package: apt-transport-https$/aMulti-Arch: foreign'</span> debian<span style="color:#000000">/</span>control
<span style="color:#838183; font-style:italic"># Increment the version in the changelog so that the original from the repo</span>
<span style="color:#838183; font-style:italic"># wouldn't override the locally patched package next time you run apt upgrade</span>
dch <span style="color:#000000">--</span><span style="color:#0057ae">local</span><span style="color:#000000">=</span><span style="color:#bf0303">'multiarch'</span> <span style="color:#bf0303">&quot;Mark the package as multi-arch foreign to satisfy skype dependencies&quot;</span>
<span style="color:#838183; font-style:italic"># dch will warn you that the current directory has been renamed,</span>
<span style="color:#838183; font-style:italic"># so let's change into it to avoid confusion</span>
<span style="color:#0057ae">cd</span> ..<span style="color:#000000">/</span>apt-<span style="color:#000000">*</span>
<span style="color:#838183; font-style:italic"># Build the packages. ALL OF THEM!</span>
dpkg-buildpackage <span style="color:#000000">-</span>uc <span style="color:#000000">-</span>us
</pre>



<p>Go grab a cup of coffee. (Or, preferrably, something without any caffeine, because your pulse must be racing from stress at this point.) <span class="caps">APT </span>is written in C++ and contains a lot of translation strings, so don&#39;t expect the build process to be done instantaneously.</p>

<p>Is it done yet? On my machine the build process additionally warned about some translations not being good enough and then crashed because of missing <code>usr/share/man/*/*/apt-something-something.*</code>. Notice the double <code>*/*/</code>: those must have been the translated man pages. I had to remove the offending lines from <code>debian/*.install</code>. It&#39;s not like I&#39;m even going to install those packages: I just need the patched <code>apt-transport-https</code>. After I applied the fix, I ran <code>fakeroot debian/rules binary</code> to restart the process from approximately where it stopped at.</p>

<p>Is it done now? Finally, you can install the multi-arch-aware <code>apt-transport-https</code>:</p>



<pre>
dpkg <span style="color:#000000">-</span>i ..<span style="color:#000000">/</span>apt-transport-https<span style="color:#000000">*</span>.deb
</pre>



<p>Then install Skype and its dependencies:</p>



<pre>
dpkg <span style="color:#000000">-</span>i ...<span style="color:#000000">/</span>path<span style="color:#000000">/</span>to<span style="color:#000000">/</span>skypeforlinux64.deb
apt-get <span style="color:#000000; font-weight:bold">install</span> <span style="color:#000000">-</span>f
</pre>



<p>Assuming that our <code>apt-transport-https</code> is patched properly, installing Skype now should <strong>not</strong> break the system.</p>

<p>Enjoy your calls! Until the next <span class="caps">APT </span>update, that is...</p>
				</div>
			</content>
		</entry>

</feed>
